"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),_EventEmitter2=require("../utils/EventEmitter"),_EventEmitter3=_interopRequireDefault(_EventEmitter2),_AddressAllocation=require("./AddressAllocation"),_AddressAllocation2=_interopRequireDefault(_AddressAllocation),_ObjectAllocation=require("../syncher/ObjectAllocation"),_ObjectAllocation2=_interopRequireDefault(_ObjectAllocation),_HypertyInstance=require("./HypertyInstance"),_HypertyInstance2=_interopRequireDefault(_HypertyInstance),_MessageFactory=require("service-framework/dist/MessageFactory"),_utils=require("../utils/utils.js"),Registry=function(e){function t(e,r,s,o,i){(0,_classCallCheck3.default)(this,t);var a=(0,_possibleConstructorReturn3.default)(this,(0,_getPrototypeOf2.default)(t).call(this));if(!e)throw new Error("runtimeURL is missing.");var n=a;n.registryURL=e+"/registry/",n.appSandbox=r,n.runtimeURL=e,n.runtimeCatalogue=o,n.remoteRegistry=i,n.idModule=s,n.identifier=Math.floor(1e4*Math.random()+1),n.expiresTime=3600,n.hypertiesListToRemove={},n.hypertiesList=[],n.protostubsList={},n.idpProxyList={},n.dataObjectList={},n.subscribedDataObjectList={},n.sandboxesList={sandbox:{},appSandbox:{}},n.pepList={},n._domain=(0,_utils.divideURL)(n.registryURL).domain,n.sandboxesList.appSandbox[e]=r;var u=new _MessageFactory.MessageFactory("false","{}");return n.messageFactory=u,a}return(0,_inherits3.default)(t,e),(0,_createClass3.default)(t,[{key:"_getIdentityAssociated",value:function(e,t){var r=this;for(var s in r.hypertiesList){var o=r.hypertiesList[s];if(o._hypertyURL===t)switch(e){case"username":return o._user.username;case"cn":return o._user.cn;case"locale":return o._user.locale;case"avatar":return o._user.avatar;case"userURL":return o._user.userURL;case".":return o._user;default:return""}}return""}},{key:"discoverDataObjectPerURL",value:function(e,t){var r=this,s=void 0;s=t?t:r._domain;var o={type:"read",from:r.registryURL,to:"domain://registry."+s+"/",body:{resource:e,search:"dataObjectPerURL"}};return new _promise2.default(function(e,t){r._messageBus.postMessage(o,function(r){var s=r.body.value;s?e(s):t("DataObject not found")})})}},{key:"getAppSandbox",value:function(){var e=this;return e.appSandbox}},{key:"getHypertyOwner",value:function(e){var t=this,r=void 0;for(var s in t.hypertiesList){var o=t.hypertiesList[s];o.hypertyURL===e&&(r=o.user.userURL)}return r}},{key:"getHypertyName",value:function(e){var t=this,r="hyperty"===(0,_utils.divideURL)(e).type,s=void 0,o=r?o=e:t.getReporterURLSynchonous(e);for(var i in t.hypertiesList){var a=t.hypertiesList[i];if(a.hypertyURL===o){s=a.objectName;break}}return s}},{key:"getReporterURL",value:function(e){var t=this,r=t.dataObjectList[e];return new _promise2.default(function(e,t){r?e(r.reporter):t("No reporter was found")})}},{key:"getReporterURLSynchonous",value:function(e){var t=this,r=t.dataObjectList[e];return r?r.reporter:void 0}},{key:"getDataObjectSubscriberHyperty",value:function(e){var t=this;return t.subscribedDataObjectList[e]}},{key:"registerSubscribedDataObject",value:function(e,t){var r=this;void 0===r.subscribedDataObjectList[e]&&(r.subscribedDataObjectList[e]=t)}},{key:"getPreAuthSubscribers",value:function(e){var t=this,r=t.dataObjectList[e],s=[];return r&&(s=r.preAuth),s}},{key:"unregisterAllHyperties",value:function(){var e=this,t=[];return new _promise2.default(function(r,s){for(var o in e.hypertiesList){var i=e.hypertiesList[o],a=e.unregisterHypertyInstance(i.user.userURL,i.hypertyURL);t.push(a)}_promise2.default.all(t).then(function(){r("successfully unregistered all hyperties")},function(e){s(e)})})}},{key:"unregisterHypertyInstance",value:function(e,t){var r=this,s={type:"delete",from:r.registryURL,to:"domain://registry."+r._domain+"/",body:{value:{user:e,url:t}}};r._messageBus.postMessage(s,function(e){console.log("unregister hyperty Reply",e)})}},{key:"deleteDataObjectInstance",value:function(e){var t=this,r={type:"delete",from:t.registryURL,to:"domain://registry."+t._domain+"/",body:{value:{name:e}}};t._messageBus.postMessage(r,function(e){console.log("unregister dataObject Reply",e)})}},{key:"updateHypertyInstance",value:function(e,t){var r=this,s={type:"UPDATE",from:r.registryURL,to:"domain://registry."+r._domain+"/",body:{resource:e,value:t}};r._messageBus.post.postMessage(s,function(e){console.log("Updated hyperty reply",e)})}},{key:"registerSubscriber",value:function(e,t){var r=this,s=r.dataObjectList[e];s&&(s.subscribers.push(t),r.dataObjectList[e]=s)}},{key:"getDataObjectSubscribers",value:function(e){var t=this,r=t.dataObjectList[e];if(r)return r.subscribers;throw"No dataObject was found"}},{key:"registerDataObject",value:function(e,t,r,s,o,i){var a=this;return new _promise2.default(function(n,u){var c=[],l=r.split(":");c.push(l[0]);var d={name:e,resources:o,dataSchemes:c,schema:t,url:r,expires:a.expiresTime,reporter:s,preAuth:i,subscribers:[]};a.dataObjectList[r]=d;var y={type:"create",from:a.registryURL,to:"domain://registry."+a.registryDomain+"/",body:{value:d,policy:"policy"}};a._messageBus.postMessage(y,function(e){console.log("===> registerDataObject Reply: ",e),200===e.body.code?n("ok"):u("error on register DataObject")})})}},{key:"registerHyperty",value:function(e,t,r){var s=this,o=(0,_utils.divideURL)(t).domain;return o.includes("catalogue")&&(o=o.replace("catalogue.","")),new _promise2.default(function(i,a){s.idModule.getIdentityAssertion().then(function(n){var u=n.userProfile,c=u.userURL;void 0===s._messageBus?a("MessageBus not found on registerStub"):s.resolve("hyperty-runtime://"+o).then(function(){s.registryDomain=o;var n=1;s.addressAllocation.create(o,n).then(function(o){o.forEach(function(e){s._messageBus.addListener(e+"/status",function(t){console.log("Message addListener for : ",e+"/status -> "+t)})}),"app"===e.type?s.sandboxesList.appSandbox[o[0]]=e:"normal"===e.type?s.sandboxesList.sandbox[o[0]]=e:a("Wrong SandboxType");var n=void 0;"string"==typeof r.hypertyType?(n=[],n.push(r.hypertyType)):n=r.hypertyType;var l=r.dataObjects,d=[];for(var y in l)d.push(s.runtimeCatalogue.getDataSchemaDescriptor(l[y]));_promise2.default.all(d).then(function(e){var l=[];for(var d in e){var y=e[d];l.push(y.sourcePackage.sourceCode.properties.scheme.constant)}var p=new _HypertyInstance2.default(s.identifier,s.registryURL,t,r,o[0],u);p._resources=n,p._dataSchemes=l,s.hypertiesList.push(p);var f={user:c,descriptor:t,url:o[0],expires:s.expiresTime,resources:n,dataSchemes:l},v={type:"create",from:s.registryURL,to:"domain://registry."+s.registryDomain+"/",body:{value:f,policy:"policy"}};s._messageBus.postMessage(v,function(e){console.log("===> RegisterHyperty Reply: ",e),200===e.body.code?i(o[0]):a("Failed to register an Hyperty")});setInterval(function(){var e={type:"create",from:s.registryURL,to:"domain://registry."+s.registryDomain+"/",body:{value:f,policy:"policy"}};s._messageBus.postMessage(e,function(e){console.log("===> KeepAlive Reply: ",e)})},s.expiresTime/1.1/2*1e3);console.log("Hyperty Schemas",l),console.log("Hyperty resources",n)})}).catch(function(e){console.log("Address Reason: ",e),a(e)})})},function(e){a("Failed to obtain an identity")})})}},{key:"unregisterHyperty",value:function(e){var t=this;return new _promise2.default(function(r,s){var o=!1,i=0;for(i=0;i<t.hypertiesList.length;i++){var a=t.hypertiesList[i];if(void 0!==a&&a.hypertyURL===e){o=!0;break}}o===!1?s("Hyperty not found"):(delete t.hypertiesList[i],r("Hyperty successfully deleted"))})}},{key:"discoverProtostub",value:function(e){if(!e)throw new Error("Parameter url needed");var t=this;return new _promise2.default(function(r,s){var o=t.protostubsList[e];void 0===o?s("requestUpdate couldn't get the ProtostubURL"):r(o)})}},{key:"registerStub",value:function(e,t){var r=this,s=void 0;return new _promise2.default(function(o,i){void 0===r._messageBus&&i("MessageBus not found on registerStub"),t.indexOf("msg-node.")||(t=t.substring(t.indexOf(".")+1)),s="msg-node."+t+"/protostub/"+Math.floor(1e4*Math.random()+1),r.protostubsList[t]=s,r.sandboxesList.sandbox[s]=e,o(s),r._messageBus.addListener(s+"/status",function(e){e.resource===e.to+"/status"&&console.log("RuntimeProtostubURL/status message: ",e.body.value)})})}},{key:"unregisterStub",value:function(e){var t=this;return new _promise2.default(function(r,s){var o=t.protostubsList[e];void 0===o?s("Error on unregisterStub: Hyperty not found"):(delete t.protostubsList[e],r("ProtostubURL removed"))})}},{key:"registerIdpProxy",value:function(e,t){var r=this,s=void 0;return new _promise2.default(function(o,i){void 0===r._messageBus&&i("MessageBus not found on registerStub"),s="domain-idp://"+t+"/stub/"+Math.floor(1e4*Math.random()+1),r.idpProxyList[t]=s,r.sandboxesList.sandbox[s]=e,o(s),r._messageBus.addListener(s+"/status",function(e){e.resource===e.to+"/status"&&console.log("idpProxyStubURL/status message: ",e.body.value)})})}},{key:"discoverIdpProxy",value:function(e){if(!e)throw new Error("Parameter url needed");var t=this;return new _promise2.default(function(r,s){var o=t.idpProxyList[e];void 0===o?s("requestUpdate couldn't get the idpProxyURL"):r(o)})}},{key:"registerPEP",value:function(e,t){var r=this;return new _promise2.default(function(s,o){r.pepList[t]=e,s("PEP registered with success")})}},{key:"unregisterPEP",value:function(e){var t=this;return new _promise2.default(function(r,s){var o=t.pepList[e];void 0===o?s("Pep Not found."):r("PEP successfully removed.")})}},{key:"onEvent",value:function(e){console.log("onEvent")}},{key:"getSandbox",value:function(e){if(!e)throw new Error("Parameter url needed");console.log("getSandbox: ",e);var t=this;return new _promise2.default(function(r,s){var o=void 0;if(o=t.sandboxesList.appSandbox[e],!o&&(o=t.sandboxesList.sandbox[e],!o)){var i=(0,_utils.divideURL)(e).domain;for(var a in t.sandboxesList.sandbox)if(a.includes(i)){o=t.sandboxesList.sandbox[a];break}}o?r(o):s("no sandbox found for: "+e)})}},{key:"resolve",value:function(e){console.log("resolve "+e);var t=this,r=(0,_utils.divideURL)(e),s=r.domain,o=r.type;return e.includes("global://registry")&&(s=t._domain),new _promise2.default(function(e,r){s.indexOf("msg-node.")&&s.indexOf("registry.")||(s=s.substring(s.indexOf(".")+1));var i=void 0;i="domain-idp"===o?t.idpProxyList[s]:t.protostubsList[s],void 0!==i?(console.info("Resolved: ",i),e(i)):"domain-idp"===o?t._loader.loadIdpProxy(s).then(function(r){i=t.idpProxyList[s],console.info("Resolved IDPProxy: ",i,r),e(i)}).catch(function(e){console.error("Error resolving IDPProxy: ",e),r(e)}):t._loader.loadStub(s).then(function(r){i=t.protostubsList[s],console.info("Resolved Protostub: ",i,r),e(i)}).catch(function(e){console.error("Error resolving Protostub: ",e),r(e)})})}},{key:"loader",set:function(e){var t=this;t._loader=e},get:function(){var e=this;return e._loader}},{key:"messageBus",get:function(){var e=this;return e._messageBus},set:function(e){var t=this;t._messageBus=e,t._messageBus.addListener(t.registryURL,function(e){var r=t._getIdentityAssociated(e.body.resource,e.body.criteria),s={id:e.id,type:"response",to:e.from,from:e.to,body:{resource:r}};s.body.code=r?200:404,t._messageBus.postMessage(s)}),t.idModule.messageBus=e;var r=new _AddressAllocation2.default(t.registryURL,e);t.addressAllocation=r;var s=new _ObjectAllocation2.default(t.registryURL+"/object-allocation",e);t.objectAllocation=s}}]),t}(_EventEmitter3.default);exports.default=Registry,module.exports=exports.default;
//# sourceMappingURL=Registry.js.map
