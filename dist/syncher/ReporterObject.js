"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_keys=require("babel-runtime/core-js/object/keys"),_keys2=_interopRequireDefault(_keys),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_utils=require("../utils/utils"),_Subscription=require("./Subscription"),_Subscription2=_interopRequireDefault(_Subscription),ReporterObject=function(){function e(r,s,o){(0,_classCallCheck3.default)(this,e);var t=this;t._parent=r,t._owner=s,t._url=o,t._bus=r._bus,t._domain=(0,_utils.divideURL)(s).domain,t._objSubscriptorURL=t._url+"/subscription",t._subscriptions={},t._childrens=[],t._childrenListeners=[],t._forwards={},t._allocateListeners()}return(0,_createClass3.default)(e,[{key:"_allocateListeners",value:function(){var e=this;e._subscriptionListener=e._bus.addListener(e._objSubscriptorURL,function(r){switch(console.log(e._objSubscriptorURL+"-RCV: ",r),r.type){case"subscribe":e._onRemoteSubscribe(r);break;case"unsubscribe":e._onRemoteUnSubscribe(r);break;case"response":e._onRemoteResponse(r)}});var r=e._url+"/changes";e._changeListener=e._bus.addListener(r,function(e){console.log("SyncherManager-"+r+"-RCV: ",e)})}},{key:"_releaseListeners",value:function(){var e=this;e._subscriptionListener.remove(),e._changeListener.remove(),e._childrenListeners.forEach(function(e){e.remove()}),(0,_keys2.default)(e._forwards).forEach(function(r){e.forwardUnSubscribe(r)}),(0,_keys2.default)(e._subscriptions).forEach(function(r){e._subscriptions[r]._releaseListeners()})}},{key:"forwardSubscribe",value:function(e){var r=this,s={type:"subscribe",from:r._parent._url,to:"domain://msg-node."+r._domain+"/sm",body:{subscribe:e,source:r._owner}};return new _promise2.default(function(o,t){r._bus.postMessage(s,function(s){if(console.log("forward-subscribe-response(reporter): ",s),200===s.body.code){var i=r._bus.addForward(r._url,r._owner);r._forwards[e[0]]=i,o()}else t("Error on msg-node subscription: "+s.body.desc)})})}},{key:"forwardUnSubscribe",value:function(e){var r=this;r._forwards[e].remove(),delete r._forwards[e];var s={type:"unsubscribe",from:r._parent._url,to:"domain://msg-node."+r._domain+"/sm",body:{subscribe:[e],source:r._owner}};r._bus.postMessage(s)}},{key:"addChildrens",value:function(e){var r=this;return new _promise2.default(function(s,o){if(0===e.length)return void s();var t=r._url+"/children/";r._childrens.push(e);var i=[];e.forEach(function(e){return i.push(t+e)});var n={type:"subscribe",from:r._parent._url,to:"domain://msg-node."+r._domain+"/sm",body:{subscribe:i,source:r._owner}};r._bus.postMessage(n,function(e){console.log("node-subscribe-response(reporter): ",e),200===e.body.code?(i.forEach(function(e){var s=r._bus.addListener(e,function(r){console.log("SyncherManager-"+e+"-RCV: ",r)});r._childrenListeners.push(s);var o=r._bus.addForward(e,r._owner);r._childrenListeners.push(o)}),s()):o("Error on msg-node subscription: "+e.body.desc)})})}},{key:"delete",value:function(){var e=this,r=(0,_utils.divideURL)(e._owner).domain;e._bus.postMessage({type:"delete",from:e._objSubscriptorURL,to:e._url+"/changes"}),e._bus.postMessage({type:"delete",from:e._parent._url,to:"domain://msg-node."+r+"/object-address-allocation",body:{resource:e._url,childrenResources:e._childrens}}),e._releaseListeners(),delete e._parent._reporters[e._url]}},{key:"_onRemoteResponse",value:function(e){var r=this;r._bus.postMessage({id:e.id,type:"response",from:e.to,to:r._url,body:{code:e.body.code,identity:e.body.identity,source:e.from}})}},{key:"_onRemoteSubscribe",value:function(e){var r=this,s=e.body.subscriber;if(r._subscriptions[s]){var o={id:e.id,type:"response",from:e.to,to:s,body:{code:500,desc:"Subscription for ("+r._url+" : "+s+") already exists!"}};return void r._bus.postMessage(o)}var t="sub/pub";if("sub/pub"===t){var i={type:"forward",from:r._url,to:r._owner,body:{type:e.type,from:s,to:r._url,identity:e.body.identity}};r._bus.postMessage(i,function(o){console.log("forward-reply: ",o),200===o.body.code&&(r._subscriptions[s]=new _Subscription2.default(r._bus,r._owner,r._url,r._childrens,(!0))),r._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:o.body})})}}},{key:"_onRemoteUnSubscribe",value:function(e){var r=this,s=e.body.subscriber,o=r._subscriptions[s];o&&(o._releaseListeners(),delete r._subscriptions[s])}}]),e}();exports.default=ReporterObject,module.exports=exports.default;
//# sourceMappingURL=ReporterObject.js.map
