{"version":3,"sources":["syncher/Subscription.js"],"names":["Subscription","bus","owner","url","childrens","isReporter","_classCallCheck3","default","this","_this","childBaseURL","changeURL","_deleteListener","addListener","msg","type","console","log","deleteMessageToHyperty","from","to","body","identity","resource","postMessage","reply","code","_releaseListeners","_changeListener","addPublish","addForward","_childrenListeners","forEach","child","childId","childrenForward","push","selfForward","remove","forward"],"mappings":"0XAAMA,wBAaE,QAAAA,GAAIC,EAAAC,EAAAC,EACFC,EAAgBC,IAAU,EAAAC,iBAAAC,SAAAC,KAAAR,EAKxB,IAAAS,GAAYD,KAUhBE,EACIP,EAAA,aAUFQ,EAAkBR,EAAI,UAhC5BM,GAAMG,gBAAkBX,EAAIY,YAAYF,EAAW,SAACG,GAClD,GAAiB,WAAbA,EAAIC,KAAmB,CACzBC,QAAQC,IAAI,wBAAyBH,EAGrC,IAAII,IACFH,KAAM,SAAUI,KAAML,EAAIK,KAAMC,GAAIlB,EACpCmB,MAAQC,SAAUR,EAAIO,KAAKC,SAAUC,SAAUpB,GAIjDF,GAAIuB,YAAYN,EAAwB,SAACO,GACvCT,QAAQC,IAAI,8BAA+BQ,GACnB,MAApBA,EAAMJ,KAAKK,MACbjB,EAAMkB,yBAOVtB,EACFI,EAAMmB,gBAAkB3B,EAAI4B,WAAWlB,GAEvCF,EAAMmB,gBAAkB3B,EAAI6B,WAAWnB,EAAWT,GAGpDO,EAAMsB,sBACN3B,EAAU4B,QAAQ,SAACC,GACjB,GAAIC,GAAUxB,EAAeuB,EAGzBE,EAAkBlC,EAAI4B,WAAWK,EAIrC,IAHAzB,EAAMsB,mBAAmBK,KAAKD,IAGzB9B,EAAY,CACf,GAAIgC,GAAcpC,EAAI6B,WAAWI,EAAShC,EAC1CO,GAAMsB,mBAAmBK,KAAKC,mFAMlC,GAAI5B,GAAQD,IAEZC,GAAMG,gBAAgB0B,SAEtB7B,EAAMmB,gBAAgBU,SAEtB7B,EAAMsB,mBAAmBC,QAAQ,SAACO,GAChCA,EAAQD,oCAMCtC","file":"syncher/Subscription.js","sourcesContent":["class Subscription {\n\n  constructor(bus, owner, url, childrens, isReporter) {\n    let _this = this;\n    let childBaseURL = url + '/children/';\n    let changeURL = url + '/changes';\n\n    //process delete message\n    _this._deleteListener = bus.addListener(changeURL, (msg) => {\n      if (msg.type === 'delete') {\n        console.log('Subscription-DELETE: ', msg);\n\n        //FLOW-OUT: message sent to all subscribers\n        let deleteMessageToHyperty = {\n          type: 'delete', from: msg.from, to: owner,\n          body: { identity: msg.body.identity, resource: url }\n        };\n\n        //send delete to hyperty\n        bus.postMessage(deleteMessageToHyperty, (reply) => {\n          console.log('Subscription-DELETE-REPLY: ', reply);\n          if (reply.body.code === 200) {\n            _this._releaseListeners();\n          }\n        });\n      }\n    });\n\n    //add change publish address or forward\n    if (isReporter) {\n      _this._changeListener = bus.addPublish(changeURL);\n    } else {\n      _this._changeListener = bus.addForward(changeURL, owner);\n    }\n\n    _this._childrenListeners = [];\n    childrens.forEach((child) => {\n      let childId = childBaseURL + child;\n\n      //add children publish address\n      let childrenForward = bus.addPublish(childId);\n      _this._childrenListeners.push(childrenForward);\n\n      //add self forward if an observer\n      if (!isReporter) {\n        let selfForward = bus.addForward(childId, owner);\n        _this._childrenListeners.push(selfForward);\n      }\n    });\n  }\n\n  _releaseListeners() {\n    let _this = this;\n\n    _this._deleteListener.remove();\n\n    _this._changeListener.remove();\n\n    _this._childrenListeners.forEach((forward) => {\n      forward.remove();\n    });\n  }\n\n}\n\nexport default Subscription;\n"],"sourceRoot":"/source/"}