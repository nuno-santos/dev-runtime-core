"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_utils=require("../utils/utils"),_ObjectAllocation=require("./ObjectAllocation"),_ObjectAllocation2=_interopRequireDefault(_ObjectAllocation),_ReporterObject=require("./ReporterObject"),_ReporterObject2=_interopRequireDefault(_ReporterObject),_ObserverObject=require("./ObserverObject"),_ObserverObject2=_interopRequireDefault(_ObserverObject),_tv=require("../utils/tv4"),_tv2=_interopRequireDefault(_tv),_MessageFactory=require("service-framework/dist/MessageFactory"),SyncherManager=function(){function e(o,r,t,s,a){(0,_classCallCheck3.default)(this,e);var c=this;c._bus=r,c._registry=t,c._catalog=s,c._url=o+"/sm",c._objectURL=o+"/object-allocation",c._reporters={},c._observers={},c._domain=(0,_utils.divideURL)(o).domain,c._mf=new _MessageFactory.MessageFactory((!1),{}),a?c._allocator=a:c._allocator=new _ObjectAllocation2.default(c._objectURL,r),r.addListener(c._url,function(e){switch(console.log("SyncherManager-RCV: ",e),e.type){case"create":c._onCreate(e);break;case"delete":c._onDelete(e);break;case"subscribe":c._onLocalSubscribe(e);break;case"unsubscribe":c._onLocalUnSubscribe(e)}})}return(0,_createClass3.default)(e,[{key:"_onCreate",value:function(e){var o=this,r=e.from,t=(0,_utils.divideURL)(e.from).domain;return e.body.resource?void o._authorise(e,e.body.resource):void o._catalog.getDataSchemaDescriptor(e.body.schema).then(function(s){var a=s.sourcePackage.sourceCode.properties,c=a.scheme?a.scheme.constant:"resource",i=a.children?a.children.constant:[];console.log("Scheme: ",c),console.log("Running object validation...");try{var n=e.body.value,u=s.sourcePackage.sourceCode;_tv2.default.addSchema(u.id,u);var l=_tv2.default.validateMultiple(n,u);l.errors.forEach(function(e){delete e.stack}),!l.valid||l.missing.length>0?(console.warn("Object validation "+(l.valid?"succeeded, but schema contained references:":"failed:"),(0,_stringify2.default)(l,null,2)),console.debug("Object:",(0,_stringify2.default)(n,null,2),"\r\nSchema:",(0,_stringify2.default)(u,null,2))):console.log("Object validation succeeded")}catch(e){console.warn("Error during object validation:",e)}o._allocator.create(t,c,1).then(function(t){var s=t[0];console.log("ALLOCATOR CREATE:",t);var a=s+"/subscription";console.log("Subscription URL",a),console.info("Register Object: ",e.body.value.name,e.body.value.schema,s,e.body.value.reporter,e.body.value.resources),o._registry.registerDataObject(e.body.value.name,e.body.value.schema,s,e.body.value.reporter,e.body.value.resources,e.body.authorise).then(function(t){console.log("DataObject successfully registered",t);var c=new _ReporterObject2.default(o,r,s);c.forwardSubscribe([s,a]).then(function(){c.addChildrens(i).then(function(){o._reporters[s]=c,o._bus.postMessage({id:e.id,type:"response",from:e.to,to:r,body:{code:200,resource:s,childrenResources:i}}),setTimeout(function(){o._authorise(e,s)})})})},function(e){console.error(e)})})}).catch(function(t){var s={id:e.id,type:"response",from:e.to,to:r,body:{code:500,desc:t}};o._bus.postMessage(s)})}},{key:"_authorise",value:function(e,o){var r=this,t=o+"/subscription";e.body.authorise.forEach(function(o){r._bus.postMessage({type:"create",from:t,to:o,body:{identity:e.body.identity,source:e.from,value:e.body.value,schema:e.body.schema}})})}},{key:"_onDelete",value:function(e){var o=this,r=e.body.resource,t=o._reporters[r];t&&(t.delete(),o._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:200}}))}},{key:"_onLocalSubscribe",value:function(e){var o=this,r=this,t=e.from,s=e.body.resource,a=s+"/subscription",c=s+"/children/",i=(0,_utils.divideURL)(s).domain;r._catalog.getDataSchemaDescriptor(e.body.schema).then(function(n){var u=n.sourcePackage.sourceCode.properties,l=u.children?u.children.constant:[],d=[];d.push(s+"/changes"),l.forEach(function(e){return d.push(c+e)});var b={type:"subscribe",from:r._url,to:"domain://msg-node."+i+"/sm",body:{identity:e.body.identity,subscribe:d,source:t}};r._bus.postMessage(b,function(c){if(console.log("node-subscribe-response(observer): ",c),200===c.body.code){r._bus.postMessage({id:e.id,type:"response",from:e.to,to:t,body:{code:100,childrenResources:l}});var i={type:"subscribe",from:r._url,to:a,body:{identity:b.body.identity,subscriber:t}};r._bus.postMessage(i,function(a){if(console.log("reporter-subscribe-response: ",a),200===a.body.code){var c=r._observers[s];c||(c=new _ObserverObject2.default(r,s,l),r._observers[s]=c),c.addSubscription(t),a.id=e.id,a.from=r._url,a.to=t,o._bus.postMessage(a)}})}else r._bus.postMessage({id:e.id,type:"response",from:e.to,to:t,body:c.body})})})}},{key:"_onLocalUnSubscribe",value:function(e){var o=this,r=e.from,t=e.body.resource,s=o._observers[t];s&&(s.removeSubscription(r),o._bus.postMessage({id:e.id,type:"response",from:e.to,to:e.from,body:{code:200}}))}},{key:"url",get:function(){return this._url}}]),e}();exports.default=SyncherManager,module.exports=exports.default;
//# sourceMappingURL=SyncherManager.js.map
