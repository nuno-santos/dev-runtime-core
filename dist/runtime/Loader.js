"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_utils=require("../utils/utils"),Loader=function(){function e(){(0,_classCallCheck3.default)(this,e)}return(0,_createClass3.default)(e,[{key:"loadHyperty",value:function(e){var r=this;if(!this._readyToUse())return!1;if(!e)throw new Error("Hyperty descriptor url parameter is needed");return new _promise2.default(function(t,n){var o=void 0,i=void 0,u=void 0,s=void 0,a=!1,c=function(e){console.error("Something failed on the deploy hyperty: ",e),n(e)},f=function(e){a=!0,n(e)};return console.info("------------------ Hyperty ------------------------"),console.info("Get hyperty descriptor for :",e),r.runtimeCatalogue.getHypertyDescriptor(e).then(function(e){console.info("1: return hyperty descriptor"),u=e;var t=e.sourcePackageURL;return"/sourcePackage"===t?e.sourcePackage:r.runtimeCatalogue.getSourcePackageFromURL(t)},f).then(function(e){if(a)return!1;console.info("2: return hyperty source code"),s=e;var r=!0;return r},f).then(function(t){if(a)return!1;console.info("3: return policy engine result"+t);var n=!0,o=void 0;if(n)o=r.registry.getAppSandbox();else{var i=(0,_utils.divideURL)(e).domain;o=r.registry.getSandbox(i)}return o},f).then(function(e){return!a&&(console.info("4: return the sandbox",e),e)},function(e){if(a)return!1;console.error("4.1: Try to register a new sandbox");var t=r._runtimeFactory.createSandbox();return t.addListener("*",function(e){r.messageBus.postMessage(e)}),t},f).then(function(t){return!a&&(console.info("5: return sandbox and register"),i=t,r.registry.registerHyperty(t,e,u))},f).then(function(e){if(a)return!1;console.info("6: Hyperty url, after register hyperty",e),o=e;var t={};if(!(0,_utils.emptyObject)(u.configuration))try{t=(0,_assign2.default)({},JSON.parse(u.configuration))}catch(e){t=u.configuration}return t.runtimeURL=r._runtimeURL,i.deployComponent(s.sourceCode,o,t)},f).then(function(e){if(a)return!1;console.info("7: Deploy component status for hyperty: ",e),r.messageBus.addListener(o,function(e){i.postMessage(e)});var n={runtimeHypertyURL:o,status:e};t(n),console.info("------------------ END ------------------------")},f).catch(c)})}},{key:"loadStub",value:function(e){var r=this;if(!this._readyToUse())return!1;if(!e)throw new Error("ProtoStub descriptor url parameter is needed");return new _promise2.default(function(t,n){var o=(0,_utils.divideURL)(e).domain;o||(o=e);var i=void 0,u=void 0,s=void 0,a=void 0,c=!1,f=function(e){console.error("Something failed on the deploy of protocolstub: ",e),n(e)},d=function(e){c=!0,n(e)};console.info("------------------- ProtoStub ---------------------------\n"),console.info("Discover or Create a new ProtoStub for domain: ",o),r.registry.discoverProtostub(o).then(function(e){console.info("1. Proto Stub Discovered: ",e);var r={runtimeProtoStubURL:e,status:"deployed"};t(r),console.info("------------------- END ---------------------------\n")}).catch(function(n){console.info("1. Proto Stub not found "+n),r.runtimeCatalogue.getStubDescriptor(e).then(function(e){if(c)return!1;console.info("2. return the ProtoStub descriptor"),u=e;var t=e.sourcePackageURL;return"/sourcePackage"===t?e.sourcePackage:r.runtimeCatalogue.getSourcePackageFromURL(t)},d).catch(f).then(function(e){if(c)return!1;console.info("3. return the ProtoStub Source Code"),a=e;var r=!0;return r},d).then(function(e){return!c&&r.registry.getSandbox(o)}).then(function(e){return!c&&(console.info("4. if the sandbox is registered then return the sandbox ",e),i=e,e)}).catch(function(e){if(c)return!1;console.info("5. Sandbox was not found, creating a new one ",e);var t=r._runtimeFactory.createSandbox();return t.addListener("*",function(e){r.messageBus.postMessage(e)}),t}).then(function(e){return!c&&(console.info("6. return the sandbox instance and register",e,"to domain ",o),i=e,r.registry.registerStub(i,o))},d).then(function(e){if(c)return!1;console.info("7. return the runtime protostub url: ",e),s=e;var t={};if(!(0,_utils.emptyObject)(u.configuration))try{t=(0,_assign2.default)({},JSON.parse(u.configuration))}catch(e){t=u.configuration}return t.runtimeURL=r._runtimeURL,i.deployComponent(a.sourceCode,e,t)},d).then(function(e){if(c)return!1;console.info("8: return deploy component for sandbox status: ",e),r.messageBus.addListener(s,function(e){i.postMessage(e)});var n={runtimeProtoStubURL:s,status:e};t(n),console.info("------------------- END ---------------------------\n")},d).catch(f)})})}},{key:"loadIdpProxy",value:function(e){var r=this;if(!this._readyToUse())return!1;if(!e)throw new Error("IdpProxy descriptor url parameter is needed");return new _promise2.default(function(t,n){var o=(0,_utils.divideURL)(e).domain;o||(o=e);var i=void 0,u=void 0,s=void 0,a=void 0,c=!1,f=function(e){console.error("Something failed on the deploy of IdpProxy: ",e),n(e)},d=function(e){c=!0,n(e)};return console.info("------------------- IDP Proxy Deploy ---------------------------\n"),console.info("Discover or Create a new IdpProxy for domain/URL: ",o),r.registry.discoverIdpProxy(o).then(function(e){console.info("1. IDPProxy Discovered: ",e);var r={runtimeIdpProxyURL:e,status:"deployed"};t(r),console.info("------------------- END ---------------------------\n")}).catch(function(n){console.info("1. IdpProxy not found:",n),r.runtimeCatalogue.getIdpProxyDescriptor(e).then(function(e){console.info("2. Return the IDPProxy descriptor"),u=e;var t=e.sourcePackageURL;return"/sourcePackage"===t?e.sourcePackage:r.runtimeCatalogue.getSourcePackageFromURL(t)},d).then(function(e){if(c)return!1;console.info("3. return the IDPProxy source package"),a=e;var r=!0;return r},d).then(function(e){return!c&&r.registry.getSandbox(o)}).then(function(e){return!c&&(console.info("4. if the sandbox is registered then return the sandbox",e),i=e,e)}).catch(function(e){if(c)return!1;console.info("5. Sandbox was not found, creating a new one",e);var t=r._runtimeFactory.createSandbox();return t.addListener("*",function(e){r.messageBus.postMessage(e)}),t}).then(function(e){return!c&&(console.info("6. return the sandbox instance and register",e,"to domain ",o),i=e,r.registry.registerIdpProxy(e,o))},d).then(function(e){if(c)return!1;console.info("7. Return the runtime Idp Proxy URL: ",e),s=e;var t={};if(!(0,_utils.emptyObject)(u.configuration))try{t=(0,_assign2.default)({},JSON.parse(u.configuration))}catch(e){t=u.configuration}return t.runtimeURL=r._runtimeURL,i.deployComponent(a.sourceCode,e,t)},d).then(function(e){if(c)return!1;console.info("8: return deploy component for sandbox status: ",e),r.messageBus.addListener(s,function(e){i.postMessage(e)});var n={runtimeIdpProxyURL:s,status:e};t(n),console.info("------------------- END ---------------------------\n")},d).catch(f)})})}},{key:"_readyToUse",value:function(){var e=!1;if(!this._runtimeURL)throw new Error("The loader need the runtime url address");if(!this._messagesBus)throw new Error("The loader need the messageBus component");if(!this._runtimeCatalogue)throw new Error("The loader need the runtimeCatalogue component");if(!this._registry)throw new Error("The loader need the registry component");if(!this._runtimeFactory)throw new Error("The loader need the runtime factory component");return e=!0}},{key:"runtimeURL",set:function(e){this._runtimeURL=e},get:function(){return this._runtimeURL}},{key:"registry",set:function(e){this._registry=e},get:function(){return this._registry}},{key:"runtimeCatalogue",set:function(e){this._runtimeCatalogue=e},get:function(){return this._runtimeCatalogue}},{key:"messageBus",set:function(e){this._messagesBus=e},get:function(){return this._messagesBus}},{key:"runtimeFactory",set:function(e){this._runtimeFactory=e},get:function(){return this._runtimeFactory}}]),e}();exports.default=Loader,module.exports=exports.default;
//# sourceMappingURL=Loader.js.map
