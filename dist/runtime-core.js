// Runtime User Agent 

// version: 0.1.0

!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.runtimeCore=e()}}(function(){return function e(t,n,r){function o(u,s){if(!n[u]){if(!t[u]){var a="function"==typeof require&&require;if(!s&&a)return a(u,!0);if(i)return i(u,!0);var c=new Error("Cannot find module '"+u+"'");throw c.code="MODULE_NOT_FOUND",c}var l=n[u]={exports:{}};t[u][0].call(l.exports,function(e){var n=t[u][1][e];return o(n?n:e)},l,l.exports,e,t,n,r)}return n[u].exports}for(var i="function"==typeof require&&require,u=0;u<r.length;u++)o(r[u]);return o}({1:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(n,"__esModule",{value:!0});var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=function(e,t,n){for(var r=!0;r;){var o=e,i=t,u=n;s=c=a=void 0,r=!1,null===o&&(o=Function.prototype);var s=Object.getOwnPropertyDescriptor(o,i);if(void 0!==s){if("value"in s)return s.value;var a=s.get;return void 0===a?void 0:a.call(u)}var c=Object.getPrototypeOf(o);if(null===c)return void 0;e=c,t=i,n=u,r=!0}},a=e("./MiniBus"),c=r(a),l=function(e){function t(e){o(this,t),s(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this._registry=e}return i(t,e),u(t,[{key:"_onPostMessage",value:function(e){var t=this;t._registry.resolve(e.header.to).then(function(n){var r=t._subscriptions[n];r&&t._publishOn(r,e)})["catch"](function(e){console.log("PROTO-STUB-ERROR: ",e)})}}]),t}(c["default"]);n["default"]=l,t.exports=n["default"]},{"./MiniBus":2}],2:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function(){function e(){r(this,e);var t=this;t._msgId=0,t._subscriptions={},t._replyTimeOut=3e3,t._replyCallbacks={},t._registerExternalListener()}return o(e,[{key:"addListener",value:function(e,t){var n=this,r=new u(n._subscriptions,e,t),o=n._subscriptions[e];return o||(o=[],n._subscriptions[e]=o),o.push(r),r}},{key:"addReplyListener",value:function(e,t,n){this._replyCallbacks[e+t]=n}},{key:"removeReplyListener",value:function(e,t){delete this._replyCallbacks[e+t]}},{key:"removeAllListenersOf",value:function(e){delete this._subscriptions[e]}},{key:"postMessage",value:function(e,t){var n=this;if(e.header.id||(n._msgId++,e.header.id=n._msgId),t&&!function(){var r=e.header.from+e.header.id;n._replyCallbacks[r]=t,setTimeout(function(){var t=n._replyCallbacks[r];if(delete n._replyCallbacks[r],t){var o={header:{id:e.header.id,type:"reply"},body:{code:"error",desc:"Reply timeout!"}};t(o)}},n._replyTimeOut)}(),!n._onReply(e)){var r=n._subscriptions[e.header.to];r?n._publishOn(r,e):n._onPostMessage(e)}return e.header.id}},{key:"bind",value:function(e,t,n){var r=this,o=this,i=o.addListener(e,function(e){n.postMessage(e)}),u=n.addListener(t,function(e){o.postMessage(e)});return{thisListener:i,targetListener:u,unbind:function(){r.thisListener.remove(),r.targetListener.remove()}}}},{key:"_publishOn",value:function(e,t){e.forEach(function(e){e._callback(t)})}},{key:"_onReply",value:function(e){var t=this;if("reply"===e.header.type){var n=e.header.to+e.header.id,r=t._replyCallbacks[n];if(delete t._replyCallbacks[n],r)return r(e),!0}return!1}},{key:"_onMessage",value:function(e){var t=this;if(!t._onReply(e)){var n=t._subscriptions[e.header.to];n?t._publishOn(n,e):(n=t._subscriptions["*"],n&&t._publishOn(n,e))}}},{key:"_onPostMessage",value:function(e){}},{key:"_registerExternalListener",value:function(){}}]),e}(),u=function(){function e(t,n,o){r(this,e);var i=this;i._subscriptions=t,i._url=n,i._callback=o}return o(e,[{key:"remove",value:function(){var e=this,t=e._subscriptions[e._url];if(t){var n=t.indexOf(e);t.splice(n,1),0===t.length&&delete e._subscriptions[e._url]}}},{key:"url",get:function(){return this._url}}]),e}();n["default"]=i,t.exports=n["default"]},{}],3:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function(){function e(){r(this,e)}return o(e,[{key:"registerIdentity",value:function(){}},{key:"registerWithRP",value:function(){}},{key:"loginWithRP",value:function(){}},{key:"setHypertyIdentity",value:function(){}},{key:"generateAssertion",value:function(e,t,n){}},{key:"validateAssertion",value:function(e){}},{key:"getAssertionTrustLevel",value:function(e){}}]),e}();n["default"]=i,t.exports=n["default"]},{}],4:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function(){function e(){r(this,e)}return o(e,[{key:"addPolicies",value:function(e,t){}},{key:"removePolicies",value:function(e){}},{key:"authorise",value:function(e){}}]),e}();n["default"]=i,t.exports=n["default"]},{}],5:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function(){function e(t,n){r(this,e);var o=this;o._url=t,o._bus=n}return o(e,[{key:"create",value:function(e,t){var n=this,r={header:{type:"create",from:n._url,to:"domain://msg-node."+e+"/hyperty-address-allocation"},body:{number:t}};return new Promise(function(e,t){n._bus.postMessage(r,function(n){"ok"===n.body.code?e(n.body.allocated):t(n.body.desc)})})}},{key:"url",get:function(){return this._url}}]),e}();n["default"]=i,t.exports=n["default"]},{}],6:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(n,"__esModule",{value:!0});var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=function(e,t,n){for(var r=!0;r;){var o=e,i=t,u=n;s=c=a=void 0,r=!1,null===o&&(o=Function.prototype);var s=Object.getOwnPropertyDescriptor(o,i);if(void 0!==s){if("value"in s)return s.value;var a=s.get;return void 0===a?void 0:a.call(u)}var c=Object.getPrototypeOf(o);if(null===c)return void 0;e=c,t=i,n=u,r=!0}},a=e("../utils/EventEmitter"),c=r(a),l=e("./AddressAllocation"),f=r(l),d=function(e){function t(e,n,r){if(o(this,t),s(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),!e)throw new Error("runtimeURL is missing.");var i=this;i.registryURL=e+"/registry/123",i.appSandbox=n,i.runtimeURL=e,i.remoteRegistry=r,i.db={},i.DB_NAME="registry-DB",i.DB_VERSION=1,i.DB_STORE_HYPERTY="hyperty-list",i.DB_STORE_STUB="protostub-list";var u=indexedDB.open(i.DB_NAME,i.DB_VERSION);u.onsuccess=function(e){i.db=this.result},u.onerror=function(e){console.error("Request open IndexedDB error:",e.target.errorCode)},u.onupgradeneeded=function(e){var t=e.currentTarget.result.createObjectStore(i.DB_STORE_HYPERTY,{keyPath:"hyperty"});t.createIndex("pepURL","pepURL",{unique:!1}),t.createIndex("identity","identity",{unique:!1}),t.createIndex("sandbox","sandbox",{unique:!1}),t.put({hyperty:"test",pepURL:null,identity:"testID"});var n=e.currentTarget.result.createObjectStore(i.DB_STORE_STUB,{keyPath:"domainURL"});n.createIndex("protostubURL","protostubURL",{unique:!1}),n.createIndex("sandbox","sandbox",{unique:!1}),n.put({domainURL:"testStub",protostubURL:"testStubURL"})}}return i(t,e),u(t,[{key:"getAppSandbox",value:function(){var e=this;return e.appSandbox}},{key:"registerHyperty",value:function(e,t){var n=this,r=t.split("/"),o=r[2],i=new Promise(function(t,r){return void 0!==n._messageBus?n.resolve("hyperty-runtime://"+o).then(function(){}).then(function(){var o=n._messageBus.addListener(n.registryURL,function(t){var r=n.db.transaction(n.DB_STORE_HYPERTY,"readwrite"),i=r.objectStore(n.DB_STORE_HYPERTY),u=t.body.hypertyRuntime;i.put({hyperty:u,pepURL:null,identity:u+"/identity",sandbox:e}),r.oncomplete=function(e){o.remove()},r.onerror=function(e){o.remove()}}),i=1,u="ua.pt";n.addressAllocation.create(u,i).then(function(e){e.forEach(function(e){n._messageBus.addListener(e+"/status",function(t){console.log("Message addListener for : ",e+"/status -> "+t)})}),t(e[0])})["catch"](function(e){console.log("Address Reason: ",e),r(e)})}):void r("MessageBus not found on registerStub")});return i}},{key:"unregisterHyperty",value:function(e){var t=this,n=t.db.transaction(t.DB_STORE_HYPERTY,"readwrite"),r=new Promise(function(r,o){var i=n.objectStore(t.DB_STORE_HYPERTY),u=i.get(e);u.onerror=function(e){o("Error on delete Hyperty")},u.onsuccess=function(n){var i=u.result;if(void 0===i)o("Error hyperty not found");else{var s=t.db.transaction(t.DB_STORE_HYPERTY,"readwrite").objectStore(t.DB_STORE_HYPERTY)["delete"](e);s.onsuccess=function(e){r("Hyperty delete with success")},s.onerror=function(e){console.error("Error deleting an Hyperty"),o("Error deleting an Hyperty")}}}});return r}},{key:"discoverProtostub",value:function(e){if(!e)throw new Error("Parameter url needed");var t=this,n=new Promise(function(n,r){var o=t.db.transaction(t.DB_STORE_STUB,"readonly"),i=o.objectStore(t.DB_STORE_STUB),u=i.get(e);u.onerror=function(e){r("requestUpdate couldn' get the ProtostubURL"),console.error("hyperty not found")},u.onsuccess=function(e){var t=u.result;void 0!==t?n(t.protostubURL):r("No protostubURL was found")}});return n}},{key:"registerStub",value:function(e,t){var n,r=this,o=new Promise(function(e,o){void 0===r._messageBus&&o("MessageBus not found on registerStub");var i=r.db.transaction(r.DB_STORE_STUB,"readwrite"),u=i.objectStore(r.DB_STORE_STUB),s=t;t.indexOf("msg-node.")||(s=t.substring(t.indexOf(".")+1)),n="msg-node."+s+"/protostub/"+Math.floor(1e4*Math.random()+1),u.put({domainURL:s,protostubURL:n}),i.onerror=function(e){o("Error on registerProtostub")},i.oncomplete=function(t){e(n),r._messageBus.addListener(n+"/status",function(e){e.header.resource===e.header.to+"/status"&&console.log("RuntimeProtostubURL/status message: ",e.body.value)})}});return o}},{key:"unregisterStub",value:function(e){var t=this,n=new Promise(function(n,r){var o=t.db.transaction(t.DB_STORE_STUB,"readwrite").objectStore(t.DB_STORE_STUB),i=o.get(e);i.onerror=function(e){r("Error on unregisterStub")},i.onsuccess=function(o){var u=i.result;if(void 0===u)r("Error on unregisterStub: Hyperty not found");else{var s=t.db.transaction(t.DB_STORE_STUB,"readwrite").objectStore(t.DB_STORE_STUB)["delete"](e);s.onerror=function(e){r("Error on unregisterStub: error on database")},s.onsuccess=function(e){n("ProtostubURL removed")}}}});return n}},{key:"registerPEP",value:function(e,t){var n,r=this,o=new Promise(function(e,o){var i=r.db.transaction(r.DB_STORE_HYPERTY,"readwrite").objectStore(r.DB_STORE_HYPERTY),u=i.get(t);u.onerror=function(e){console.error("URL not found"),o("Error on registerPEP")},u.onsuccess=function(r){n=t+"/pep";var s=u.result;if(void 0===s)o("Error on registerPEP");else{s.pepURL=n;var a=i.put(s);a.onerror=function(e){o("Error on update registerPEP")},a.onsuccess=function(t){e(n)}}}});return o}},{key:"unregisterPEP",value:function(e){var t=this,n=new Promise(function(n,r){var o=t.db.transaction(t.DB_STORE_HYPERTY,"readwrite").objectStore(t.DB_STORE_HYPERTY),i=o.get(e);i.onerror=function(e){r("Error on unregisterPEP")},i.onsuccess=function(e){var t=i.result;if(void 0===t)r("Error on unregisterPEP: hyperty not found");else{t.pepURL=null;var u=o.put(t);u.onerror=function(e){r("Error on unregisterPEP: error on update dabatase")},u.onsuccess=function(e){n(" PEP sucessfully deleted")}}}});return n}},{key:"onEvent",value:function(e){}},{key:"getSandbox",value:function(e){if(!e)throw new Error("Parameter url needed");var t=this,n=new Promise(function(n,r){var o=t.db.transaction(t.DB_STORE_HYPERTY,"readonly").objectStore(t.DB_STORE_HYPERTY),i=o.get(e);i.onerror=function(e){r("requestUpdate couldn't get the sandbox")},i.onsuccess=function(o){var u=i.result;void 0!==u?n(u.sandbox):!function(){var o=t.db.transaction(t.DB_STORE_STUB,"readonly").objectStore(t.DB_STORE_STUB),i=o.get(e);i.onerror=function(e){return r("requestUpdate couldn't get the sandbox")},i.onsuccess=function(e){var t=i.result;return void 0!==t?n(t.sandbox):r("No sandbox was found")}}()}});return n}},{key:"resolve",value:function(e){console.log("resolve "+e);var t=this,n=e.split("/"),r=n[2],o=new Promise(function(n,o){var i=t.db.transaction(t.DB_STORE_STUB,"readonly"),u=i.objectStore(t.DB_STORE_STUB);r.indexOf("msg-node.")||(r=r.substring(r.indexOf(".")+1));var s=u.get(r);t.addEventListener("runtime:stubLoaded",function(e){n(e)}),s.onsuccess=function(e){var o=s.result;void 0!==o?n(o.protostubURL):t.trigger("runtime:loadStub",r)},s.onerror=function(t){o("The url "+e+" doesn't exist: error on dababase")}});return o}},{key:"messageBus",get:function(){var e=this;return e._messageBus},set:function(e){var t=this;t._messageBus=e;var n=new f["default"](t.registryURL,e);t.addressAllocation=n}}]),t}(c["default"]);n["default"]=d,t.exports=n["default"]},{"../utils/EventEmitter":11,"./AddressAllocation":5}],7:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(n,"__esModule",{value:!0});var o=e("./runtime/RuntimeUA"),i=r(o),u=e("./sandbox/Sandbox"),s=r(u),a=i["default"];n.RuntimeUA=a;var c=s["default"];n.Sandbox=c},{"./runtime/RuntimeUA":8,"./sandbox/Sandbox":9}],8:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=e("../registry/Registry"),s=r(u),a=e("../identity/IdentityModule"),c=r(a),l=e("../policy/PolicyEngine"),f=r(l),d=e("../bus/MessageBus"),y=r(d),p=function(){function e(t){if(o(this,e),!t)throw new Error("The sandbox factory is a needed parameter");var n=this;n.sandboxFactory=t;var r="runtime://sp1/"+Math.floor(1e4*Math.random()+1);n.hypertyRuntimeURL=r;var i=t.createAppSandbox();n.identityModule=new c["default"],n.policyEngine=new f["default"],n.registry=new s["default"](r,i),n.messageBus=new y["default"](n.registry),n.registry.messageBus=n.messageBus,n.registry.addEventListener("runtime:loadStub",function(e){n.loadStub(e).then(function(t){n.registry.trigger("runtime:stubLoaded",e)})["catch"](function(e){console.error(e)})}),t.messageBus=n.messageBus}return i(e,[{key:"getHypertyDescriptor",value:function(e){return new Promise(function(t,n){var r=e.substr(e.lastIndexOf("/")+1),o={guid:"guid",id:"idHyperty",classname:r,description:"description of "+r,kind:"hyperty",catalogueURL:"....",sourceCode:"../resources/"+r+".ES5.js",dataObject:"",type:"",messageSchema:"",configuration:"",policies:"",constraints:"",hypertyCapabilities:"",protocolCapabilities:""};t(o)})}},{key:"getHypertySourceCode",value:function(e){return new Promise(function(t,n){var r=new XMLHttpRequest;r.onreadystatechange=function(e){var r=e.currentTarget;4===r.readyState&&(200===r.status?t(r.responseText):n(r.responseText))},r.open("GET",e,!0),r.send()})}},{key:"getHypertyRuntimeURL",value:function(){return _hypertyRuntimeURL}},{key:"discoverHiperty",value:function(e){}},{key:"registerHyperty",value:function(e,t){}},{key:"loadHyperty",value:function(e){var t=this;if(!e)throw new Error("Hyperty descriptor url parameter is needed");return new Promise(function(n,r){var o=void 0,i=void 0,u=void 0,s=void 0,a=function(e){console.error(e),r(e)};console.log("------------------ Hyperty ------------------------"),console.info("Get hyperty descriptor for :",e),t.getHypertyDescriptor(e).then(function(e){console.info("1: return hyperty descriptor",e),u=e;var n=e.sourceCode;return t.getHypertySourceCode(n)}).then(function(e){console.info("2: return hyperty source code"),s=e;var t=!0;return t}).then(function(e){console.info("3: return policy engine result");var n=!0,r=void 0;return r=n?t.registry.getAppSandbox():t.registry.getSandbox(domain)}).then(function(e){return console.info("4: return the sandbox",e),e},function(e){return console.info("4.1: try to register a new sandbox",e),t.sandboxFactory.createSandbox()}).then(function(n){return console.info("5: return sandbox and register"),i=n,t.registry.registerHyperty(n,e)}).then(function(e){return console.info("6: Hyperty url, after register hyperty",e),o=e,i.deployComponent(s,o,u.configuration)}).then(function(e){console.info("7: Deploy component status for hyperty: ",o),t.messageBus.addListener(o,function(e){i.postMessage(e)}),i.addListener("*",function(e){t.messageBus.postMessage(e)});var r={runtimeHypertyURL:o,status:"Deployed"};n(r),console.log("------------------ END ------------------------")})["catch"](a)})}},{key:"getStubDescriptor",value:function(e){var t=this;return new Promise(function(e,n){var r={guid:"guid",id:"idProtoStub",classname:"VertxProtoStub",description:"description of ProtoStub",kind:"hyperty",catalogueURL:"....",sourceCode:"../resources/VertxProtoStub.js",dataObject:"",type:"",messageSchema:"",configuration:{url:"ws://localhost:9090/ws",runtimeURL:t.hypertyRuntimeURL},policies:"",constraints:"",hypertyCapabilities:"",protocolCapabilities:""};e(r)})}},{key:"getStubSourceCode",value:function(e){return new Promise(function(t,n){var r=new XMLHttpRequest;r.onreadystatechange=function(e){var r=e.currentTarget;4===r.readyState&&(200===r.status?t(r.responseText):n(r.responseText))},r.open("GET",e,!0),r.send()})}},{key:"loadStub",value:function(e){var t=this;if(!e)throw new Error("domain parameter is needed");return new Promise(function(n,r){var o=void 0,i=void 0,u=void 0,s=void 0,a=function(e){console.error(e),r(e)};console.info("------------------- ProtoStub ---------------------------\n"),console.info("Discover or Create a new ProtoStub for domain: ",e),t.registry.discoverProtostub(e).then(function(e){return console.info("1. Proto Stub Discovered: ",e),i=e},function(n){return console.info("1. Proto Stub not found:",n),t.getStubDescriptor(e)}).then(function(e){console.info("2. return the ProtoStub descriptor:",e),i=e;var n=e.sourceCode;return t.getStubSourceCode(n)}).then(function(e){console.info("3. return the ProtoStub Source Code: "),s=e;var t=!0;return t}).then(function(n){return t.registry.getSandbox(e)}).then(function(e){return console.info("4. if the sandbox is registered then return the sandbox",e),o=e,e},function(e){return console.info("5. Sandbox was not found, creating a new one"),t.sandboxFactory.createSandbox()}).then(function(n){return console.info("6. return the sandbox instance and the register",n),o=n,t.registry.registerStub(o,e)}).then(function(e){return console.info("7. return the runtime protostub url: ",e),u=e,o.deployComponent(s,e,i.configuration)}).then(function(e){console.info("8: return deploy component for sandbox status"),t.messageBus.addListener(u,function(e){o.postMessage(e)}),o.addListener("*",function(e){t.messageBus.postMessage(e)});var r={runtimeProtoStubURL:u,status:"Deployed"};n(r),console.info("------------------- END ---------------------------\n")})["catch"](a)})}},{key:"checkForUpdate",value:function(e){}}]),e}();n["default"]=p,t.exports=n["default"]},{"../bus/MessageBus":1,"../identity/IdentityModule":3,"../policy/PolicyEngine":4,"../registry/Registry":6}],9:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(n,"__esModule",{value:!0});var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=function(e,t,n){for(var r=!0;r;){var o=e,i=t,u=n;s=c=a=void 0,r=!1,null===o&&(o=Function.prototype);var s=Object.getOwnPropertyDescriptor(o,i);if(void 0!==s){if("value"in s)return s.value;var a=s.get;return void 0===a?void 0:a.call(u)}var c=Object.getPrototypeOf(o);if(null===c)return void 0;e=c,t=i,n=u,r=!0}},a=e("../sandbox/SandboxRegistry"),c=r(a),l=e("../bus/MiniBus"),f=r(l),d=function(e){function t(){o(this,t),s(Object.getPrototypeOf(t.prototype),"constructor",this).call(this)}return i(t,e),u(t,[{key:"deployComponent",value:function(e,t,n){var r=this;return new Promise(function(o,i){var u={header:{type:"CREATE",from:c["default"].ExternalDeployAddress,to:c["default"].InternalDeployAddress},body:{url:t,sourceCode:e,config:n}};r.postMessage(u,function(e){"ok"===e.body.code?o("deployed"):i(e.body.desc)})})}},{key:"removeComponent",value:function(e){var t=this;return new Promise(function(n,r){var o={header:{type:"REMOVE",from:c["default"].ExternalDeployAddress,to:c["default"].InternalDeployAddress},body:{url:e}};t.postMessage(o,function(e){"ok"===e.body.code?n("undeployed"):r(e.body.desc)})})}}]),t}(f["default"]);n["default"]=d,t.exports=n["default"]},{"../bus/MiniBus":2,"../sandbox/SandboxRegistry":10}],10:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function(){function e(t){r(this,e);var n=this;n._bus=t,n._components={},t.addListener(e.InternalDeployAddress,function(t){var r={header:{id:t.header.id,type:"reply",from:e.InternalDeployAddress,to:e.ExternalDeployAddress}};switch(t.header.type){case"CREATE":n._onDeploy(r,t.body.url,t.body.sourceCode,t.body.config);break;case"REMOVE":n._onRemove(r,t.body.url)}})}return o(e,[{key:"_onDeploy",value:function(e,t,n,r){var o=this;if(o._components.hasOwnProperty(t))e.body={code:"error",desc:"Instance "+t+" already exist!"};else try{o._components[t]=o._create(t,n,r),e.body={code:"ok"}}catch(i){e.body={code:"error",desc:i}}o._bus.postMessage(e)}},{key:"_onRemove",value:function(e,t){var n=this;n._components.hasOwnProperty(t)?(delete n._components[t],n._bus.removeAllListenersOf(t),e.body={code:"ok"}):e.body={code:"error",desc:"Instance "+t+" doesn't exist!"},n._bus.postMessage(e)}},{key:"_create",value:function(e,t,n){}},{key:"components",get:function(){return this._components}}]),e}();i.ExternalDeployAddress="sandbox://external",i.InternalDeployAddress="sandbox://internal",n["default"]=i,t.exports=n["default"]},{}],11:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function(){function e(){r(this,e)}return o(e,[{key:"addEventListener",value:function(e,t){var n=this;n[e]=t}},{key:"trigger",value:function(e,t){var n=this;n[e]&&n[e](t)}}]),e}();n["default"]=i,t.exports=n["default"]},{}]},{},[7])(7)});