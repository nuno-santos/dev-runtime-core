"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_GraphConnectorContactData=require("./GraphConnectorContactData"),_GraphConnectorContactData2=_interopRequireDefault(_GraphConnectorContactData),_BloomFilter=require("./BloomFilter"),_BloomFilter2=_interopRequireDefault(_BloomFilter),_GlobalRegistryRecord=require("./GlobalRegistryRecord"),_GlobalRegistryRecord2=_interopRequireDefault(_GlobalRegistryRecord),_bitcoinjsLib=require("bitcoinjs-lib"),_bitcoinjsLib2=_interopRequireDefault(_bitcoinjsLib),_bip=require("bip39"),_bip2=_interopRequireDefault(_bip),_sjcl=require("sjcl"),_sjcl2=_interopRequireDefault(_sjcl),_jsrsasign=require("jsrsasign"),_jsrsasign2=_interopRequireDefault(_jsrsasign),_base64Url=require("base64-url"),_base64Url2=_interopRequireDefault(_base64Url),_hex=require("hex64"),_hex2=_interopRequireDefault(_hex),_buffer=require("buffer"),_buffer2=_interopRequireDefault(_buffer),GraphConnector=function(){function e(t,r){(0,_classCallCheck3.default)(this,e),this.contacts=[],this.lastCalculationBloomFilter1Hop=new Date(0).toISOString(),this.globalRegistryRecord=new _GlobalRegistryRecord2.default,this._prvKey,this.privateKey,this.groups=[],this.residenceLocation,this.firstName,this.lastName,this._messageBus=r,this._hypertyRuntimeURL=t}return(0,_createClass3.default)(e,[{key:"generateGUID",value:function(){_buffer2.default.TYPED_ARRAY_SUPPORT=!0;var e=_bip2.default.generateMnemonic(160),t=_bip2.default.generateMnemonic(8);this._createKeys(e,t),this.globalRegistryRecord.lastUpdate=(new Date).toISOString();var r=new Date;r.setMonth(r.getMonth()+120),this.globalRegistryRecord.timeout=r.toISOString(),this.globalRegistryRecord.active=1,this.globalRegistryRecord.revoked=0;var s=e+" "+t;return s}},{key:"useGUID",value:function(e){var t=e.lastIndexOf(" "),r=e.substring(0,t),s=e.substring(t+1,e.length);this._createKeys(r,s);var i=this,a={type:"READ",from:this._hypertyRuntimeURL+"/graph-connector",to:"global://registry/",body:{guid:this.globalRegistryRecord.guid}};return new _promise2.default(function(e,t){void 0===i.messageBus?t("MessageBus not found on GraphConnector"):i.messageBus.postMessage(a,function(r){var s=r.body.data,a=KJUR.jws.JWS.parse(r.body.data),o=a.payloadObj.data,l=_base64Url2.default.decode(o),n=JSON.parse(l),u=n.publicKey==i.globalRegistryRecord.publicKey;if(u){var c=_jsrsasign2.default.KEYUTIL.getKey(n.publicKey),g=s.split(".").slice(0,2).join("."),d=a.sigHex,p=new KJUR.crypto.Signature({alg:"SHA256withECDSA"});p.init(c),p.updateString(g);var h=p.verify(d);h?("undefined"!=typeof n.userIDs&&null!=n.userIDs&&(i.globalRegistryRecord.userIDs=n.userIDs),i.globalRegistryRecord.lastUpdate=n.lastUpdate,i.globalRegistryRecord.timeout=n.timeout,i.globalRegistryRecord.salt=n.salt,i.globalRegistryRecord.active=n.active,i.globalRegistryRecord.revoked=n.revoked,e(i.globalRegistryRecord)):t("Retrieved Record not valid!")}else t("Retrieved key does not match!")})})}},{key:"_createKeys",value:function(e,t){var r=_bip2.default.mnemonicToSeed(e);_buffer2.default.TYPED_ARRAY_SUPPORT=!1;var s=_bitcoinjsLib2.default.HDNode.fromSeedBuffer(r),i=KJUR.crypto.ECParameterDB.getByName("secp256k1"),a=s.keyPair.d,o=i.G.multiply(a),l=o.getX().toBigInteger(),n=o.getY().toBigInteger(),u=i.keylen/4,c=("0000000000"+a.toString(16)).slice(-u),g=("0000000000"+l.toString(16)).slice(-u),d=("0000000000"+n.toString(16)).slice(-u),p="04"+g+d;this._prvKey=new KJUR.crypto.ECDSA({curve:"secp256k1"}),this._prvKey.setPrivateKeyHex(c),this._prvKey.isPrivate=!0,this._prvKey.isPublic=!1;var h=new KJUR.crypto.ECDSA({curve:"secp256k1"});this.privateKey=_jsrsasign2.default.KEYUTIL.getPEM(this._prvKey,"PKCS8PRV"),h.setPublicKeyHex(p),h.isPrivate=!1,h.isPublic=!0;var y=_jsrsasign2.default.KEYUTIL.getPEM(h,"PKCS8PUB");y=y.replace(/(\r\n|\n|\r)/gm,""),this.globalRegistryRecord.publicKey=y;var f=_sjcl2.default.hash.sha256.hash(t),R=_sjcl2.default.codec.base64.fromBits(f);this.globalRegistryRecord.salt=R;var _=1e4,b=_sjcl2.default.misc.pbkdf2(this.globalRegistryRecord.publicKey,R,_),v=_sjcl2.default.codec.base64url.fromBits(b);this.globalRegistryRecord.guid=v}},{key:"signGlobalRegistryRecord",value:function(){var e=this.globalRegistryRecord.getRecord(),t=(0,_stringify2.default)(e),r=_base64Url2.default.encode(t),s=KJUR.jws.JWS.sign(null,{alg:"ES256"},{data:r},this._prvKey),i=s.split(".").slice(0,2).join("."),a=new KJUR.crypto.Signature({alg:"SHA256withECDSA"});a.init(this.privateKey),a.updateString(i);var o=a.sign(),l=_hex2.default.toBase64(o),n=i+"."+l;return n}},{key:"sendGlobalRegistryRecord",value:function(e){var t=KJUR.jws.JWS.parse(e).payloadObj,r=(t.guid,this),s={type:"CREATE",from:this._hypertyRuntimeURL+"/graph-connector",to:"global://registry/",body:{guid:this.globalRegistryRecord.guid,jwt:e}};return new _promise2.default(function(e,t){void 0===r.messageBus?t("MessageBus not found on GraphConnector"):r.messageBus.postMessage(s,function(r){var s=r.body.responseCode;200==s?e(200):t(s)})})}},{key:"queryGlobalRegistry",value:function(e){var t=this,r={type:"READ",from:this._hypertyRuntimeURL+"/graph-connector",to:"global://registry/",body:{guid:e}};return new _promise2.default(function(e,s){void 0===t.messageBus?s("MessageBus not found on GraphConnector"):t.messageBus.postMessage(r,function(t){var r=t.body.data,i=KJUR.jws.JWS.parse(t.body.data),a=i.payloadObj.data,o=_base64Url2.default.decode(a),l=JSON.parse(o),n=_jsrsasign2.default.KEYUTIL.getKey(l.publicKey),u=r.split(".").slice(0,2).join("."),c=i.sigHex,g=new KJUR.crypto.Signature({alg:"SHA256withECDSA"});g.init(n),g.updateString(u);var d=g.verify(c);if(d){var p=new _GraphConnectorContactData2.default(l.guid,"","");"undefined"!=typeof l.userIDs&&null!=l.userIDs&&(p.userIDs=l.userIDs),e(p)}else s("Retrieved Record not valid!")})})}},{key:"addUserID",value:function(e){for(var t=!1,r=0;r<this.globalRegistryRecord.userIDs.length;r++)this.globalRegistryRecord.userIDs==e&&(t=!0);t||this.globalRegistryRecord.userIDs.push(e)}},{key:"removeUserID",value:function(e){for(var t=0;t<this.globalRegistryRecord.userIDs.length;t++)this.globalRegistryRecord.userIDs==e&&this.globalRegistryRecord.userIDs.splice(t,1)}},{key:"addContact",value:function(e,t,r){this.contacts.push(new _GraphConnectorContactData2.default(e,t,r))}},{key:"removeContact",value:function(e){for(var t=0;t<this.contacts.length;t++)this.contacts[t].guid==e&&this.contacts.splice(t,1);this.calculateBloomFilter1Hop()}},{key:"calculateBloomFilter1Hop",value:function(){for(var e=new _BloomFilter2.default(431328,10),t=0;t<this.contacts.length;t++)this.contacts[t].privateContact||e.add(this.contacts[t].guid);this.contactsBloomFilter1Hop=e,this.lastCalculationBloomFilter1Hop=(new Date).toISOString()}},{key:"getContact",value:function(e){for(var t=[],r=0;r<this.contacts.length;r++)this.contacts[r].firstName!=e&&this.contacts[r].lastName!=e||t.push(this.contacts[r]);return t}},{key:"checkGUID",value:function(e){for(var t=[],r=[],s=0;s<this.contacts.length;s++){this.contacts[s].guid==e&&t.push(this.contacts[s]);var i=this.contacts[s].contactsBloomFilter1Hop;void 0!==i&&i.test(e)&&r.push(this.contacts[s])}var a=[];return a.push(t,r),a}},{key:"messageBus",get:function(){return this._messageBus},set:function(e){this._messageBus=e}}]),e}();exports.default=GraphConnector,module.exports=exports.default;
//# sourceMappingURL=GraphConnector.js.map
