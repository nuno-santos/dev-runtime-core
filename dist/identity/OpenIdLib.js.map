{"version":3,"sources":["identity/OpenIdLib.js"],"names":["OpenIdLib","identityProvider","clientID","_classCallCheck3","default","this","_this","googleInfo","GoogleInfo","info","facebookInfo","FacebookInfo","microsoftInfo","MicrosoftInfo","URL","REDIRECT","acToken","tokenType","expiresIn","_promise2","resolve","reject","gup","url","name","replace","regexS","regex","RegExp","results","exec","win","window","open","pollTimer","setInterval","closed","clearInterval","redirectURL","document","indexOf","code","TOKENEND","CLIENTID","close","req","XMLHttpRequest","setRequestHeader","data","FormData","append","onreadystatechange","e","readyState","status","send","VALIDURL","token","tokenID","JSON","parse","responseText","USERINFURL","infoToken","email","identityURL","substring","length","identityBundle","identity","accessToken","idToken","idp","OAUTHURL","SCOPE","TYPE","AUTHEND"],"mappings":"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","file":"identity/OpenIdLib.js","sourcesContent":["//import hello from 'hellojs';\n\n/**\n*  class to facilitate the operations with the openID connect, through several Identity Providers\n*\n*/\nclass OpenIdLib {\n\n  constructor(identityProvider, clientID) {\n    let _this = this;\n    _this.clientID = clientID;\n    _this.identityProvider = identityProvider;\n\n    switch (identityProvider) {\n      case 'google':\n        let googleInfo = new GoogleInfo();\n        _this.info = googleInfo;\n        break;\n      case 'facebook':\n        let facebookInfo = new FacebookInfo();\n        _this.info = facebookInfo;\n        break;\n      case 'windows':\n        let microsoftInfo = new MicrosoftInfo();\n        _this.info = microsoftInfo;\n        break;\n      default:\n        break;\n    }\n  }\n\n  openPopup() {\n    let _this = this;\n\n    let REDIRECT   =   _this.info.REDIRECT;\n    let URL        =   _this.info.URL;\n\n    let acToken;\n    let tokenType;\n    let expiresIn;\n\n    return new Promise(function(resolve,reject) {\n\n      //function to parse the query string in the given URL to obatin certain values\n      function gup(url, name) {\n        name = name.replace(/[\\[]/, '\\\\\\[').replace(/[\\]]/, '\\\\\\]');\n        let regexS = '[\\\\#&?]' + name + '=([^&#]*)';\n        let regex = new RegExp(regexS);\n        let results = regex.exec(url);\n        if (results === null)\n        return '';\n        else\n        return results[1];\n      }\n\n      /*hello.init({google: '808329566012-tqr8qoh111942gd2kg007t0s8f277roi.apps.googleusercontent.com',\n                 facebook: '655302667942219',\n                 windows: 'asdf197f6ad6-808f-4ddc-b725-3d8fe2660349'});\n      hello(_this.identityProvider).login({scope: 'email'}).then(function(token) {\n        console.log(token);\n        resolve(token.authResponse.access_token);\n      }, function(error) {\n        console.log('errorValidating ', error);\n        reject(error);\n      });*/\n\n      let win = window.open(URL, 'openIDrequest', 'width=800, height=600');\n      let pollTimer = window.setInterval(function() {\n        try {\n          //console.log(win.document.URL);\n\n          if (win.closed) {\n            reject('Some error occured.');\n            clearInterval(pollTimer);\n          }\n\n          let redirectURL = document.URL;//window.location.origin;\n          if (win.document.URL.indexOf('REDIRECT') !== -1 || win.document.URL.indexOf(redirectURL) !== -1) {\n            window.clearInterval(pollTimer);\n            let url =   win.document.URL;\n\n            //not working yet. Some problems with the 'POST' method\n            if (_this.identityProvider === 'windows') {\n              let code = gup(url, 'code');\n              let sessionState = gup(url, 'session_state');\n\n              let reqAccessURL = _this.info.TOKENEND + 'redirect_uri=' + _this.info.REDIRECT + '&grant_type=authorization_code' + '&client_id=' + _this.info.CLIENTID + '&code=' + code;\n\n              win.close();\n\n              let req = new XMLHttpRequest();\n              req.open('POST',  _this.info.TOKENEND, true);\n              req.setRequestHeader('Access-Control-Allow-Origin', '*');\n\n              let data = new FormData();\n              data.append('redirect_uri', _this.info.REDIRECT);\n              data.append('grant_type', 'authorization_code');\n              data.append('client_id', _this.info.CLIENTID);\n              data.append('code', code);\n\n              req.onreadystatechange = function(e) {\n                if (req.readyState === 4) {\n                  if (req.status === 200) {\n\n                    resolve('null');\n                  } else if (req.status === 400) {\n                    reject('There was an error processing the token');\n                  } else {\n                    reject('something else other than 200 was returned');\n                  }\n                }\n              };\n              req.send(data);\n\n            } else {\n\n              acToken =   gup(url, 'access_token');\n              tokenType = gup(url, 'token_type'); //FACEBOOK does not return tokenType in the field\n              expiresIn = gup(url, 'expires_in');\n\n              win.close();\n\n              if (_this.identityProvider === 'facebook') {\n                _this.info.VALIDURL = 'https://graph.facebook.com/debug_token?input_token=' + acToken + '&access_token=';\n              }\n\n              //after receiving the access token, google requires to validate first the token to prevent confused deputy problem.\n              resolve(acToken);\n            }\n          }\n        } catch (e) {\n          //console.log(e);\n        }\n      }, 1000);\n    });\n  }\n\n  validateToken(token) {\n    let _this = this;\n    let tokenID;\n    let VALIDURL = _this.info.VALIDURL;\n    return new Promise(function(resolve, reject) {\n      let req = new XMLHttpRequest();\n      req.open('GET', VALIDURL + token, true);\n\n      req.onreadystatechange = function(e) {\n        if (req.readyState === 4) {\n          if (req.status === 200) {\n            tokenID = JSON.parse(req.responseText);\n\n            resolve({token:token, tokenID: tokenID});\n          } else if (req.status === 400) {\n            reject('There was an error processing the token');\n          } else {\n            reject('something else other than 200 was returned');\n          }\n        }\n      };\n      req.send();\n\n    });\n  }\n\n  //function to exchange the access token with an ID Token containing the information\n  getInfoToken(token, tokenID) {\n    let _this = this;\n\n    return new Promise(function(resolve,reject) {\n      let USERINFURL =   _this.info.USERINFURL;\n\n      let req = new XMLHttpRequest();\n      req.open('GET', USERINFURL + token, true);\n\n      req.onreadystatechange = function(e) {\n        if (req.readyState === 4) {\n          if (req.status === 200) {\n            let infoToken = JSON.parse(req.responseText);\n            let email = infoToken.email;\n\n            //contruct the identityURL to be defined as in specification\n            // model: user://<idpdomain>/<user-identifier>\n            let identityURL = 'user://' + email.substring(email.indexOf('@') + 1, email.length) + '/' + email.substring(0, email.indexOf('@'));\n\n            //TODO remove later the 'token' field key\n            let identityBundle = {identity: identityURL, token: infoToken, accessToken: token, idToken: tokenID, infoToken: infoToken, idp: 'google'};\n\n            resolve(identityBundle);\n          } else if (req.status === 400) {\n            reject('There was an error processing the token');\n          } else {\n            reject('something else other than 200 was returned');\n          }\n        }\n      };\n      req.send();\n    });\n  }\n}\n\n//Google works fine with OpenID connect\nclass GoogleInfo {\n  constructor() {\n    let _this = this;\n    _this.OAUTHURL   =   'https://accounts.google.com/o/oauth2/auth?';\n    _this.SCOPE      =   'email%20profile';\n    _this.CLIENTID   =   '808329566012-tqr8qoh111942gd2kg007t0s8f277roi.apps.googleusercontent.com';\n    _this.REDIRECT   =    document.URL;\n    _this.TYPE       =   'token';\n    _this.VALIDURL   =   'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=';\n    _this.USERINFURL =   'https://www.googleapis.com/oauth2/v1/userinfo?access_token=';\n\n    _this.URL        =   _this.OAUTHURL + 'scope=' + _this.SCOPE + '&client_id=' + _this.CLIENTID + '&redirect_uri=' + _this.REDIRECT + '&response_type=' + _this.TYPE;\n  }\n}\n\n//Facebook only provides the support for Oauth2 Tokens, and do not directly provide support for OpenID connect. So, no 'oficial' ID token can be requested, just information about the user.\nclass FacebookInfo {\n  constructor() {\n    let _this = this;\n    _this.OAUTHURL   =    'https://www.facebook.com/dialog/oauth?';\n    _this.CLIENTID   =    655302667942219;\n    _this.REDIRECT   =    document.URL; // 'http://localhost:8080/example/index.html';\n    _this.TYPE       =    'token';\n    _this.VALIDURL   =    'https://graph.facebook.com/debug_token?input_token='; //must be updated later\n    _this.USERINFURL = 'https://graph.facebook.com/v2.5/me?fields=id,name,email,picture&access_token=';\n    _this.URL        =    _this.OAUTHURL + 'client_id=' + _this.CLIENTID + '&redirect_uri=' + _this.REDIRECT + '&response_type=' + _this.TYPE;\n  }\n}\n\n\n//Microsoft is not yet implemented to obtain the Access token / ID token. Some troubles to request the Access token, since it is required to make a http Post request with the authorization code.\nclass MicrosoftInfo {\n  constructor() {\n    let _this = this;\n    _this.OAUTHURL   =    'https://login.microsoftonline.com/common/oauth2/authorize?';\n    _this.CLIENTID   =    '7e2f3589-4b38-4b1c-a321-c9251de00ef2';\n    _this.REDIRECT   =    document.URL;//'http%3A%2F%2Flocalhost%3A8080%2Fexample%2Findex%2Ehtml'\n    _this.TYPE       =    'code';\n\n    _this.TOKENEND   =    'https://login.microsoftonline.com/3fa4042c-7c4d-4382-aba8-fc8ec61103a4/oauth2/token';\n    _this.AUTHEND    =    'https://login.microsoftonline.com/3fa4042c-7c4d-4382-aba8-fc8ec61103a4/oauth2/authorize?';\n\n    _this.URL        =    _this.AUTHEND + 'response_type=' + _this.TYPE + '&client_id=' +\n    _this.CLIENTID ;//+ '&redirect_uri=' + _this.REDIRECT;\n  }\n\n}\n\nexport default OpenIdLib;\n"],"sourceRoot":"/source/"}