"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_utils=require("../utils/utils.js"),_Identity=require("./Identity"),_Identity2=_interopRequireDefault(_Identity),_Crypto=require("./Crypto"),_Crypto2=_interopRequireDefault(_Crypto),_GuiFake=require("./GuiFake"),_GuiFake2=_interopRequireDefault(_GuiFake),IdentityModule=function(){function e(t){(0,_classCallCheck3.default)(this,e);var r=this;if(!t)throw new Error("runtimeURL is missing.");r._runtimeURL=t,r._idmURL=r._runtimeURL+"/idm",r._guiURL=r._runtimeURL+"/identity-gui",r._domain=(0,_utils.divideURL)(r._runtimeURL).domain,r.identities=[];var o=new _Identity2.default("guid","HUMAN");r.identity=o,r.crypto=new _Crypto2.default,r.dataObjectsIdentity={},r.chatKeys={},r.dataObjectSessionKeys={},r.isToUseEncryption=!0}return(0,_createClass3.default)(e,[{key:"identityRequestToGUI",value:function(e){var t=this;return new _promise2.default(function(r,o){var n={type:"create",to:t._guiURL,from:t._idmURL,body:{value:e}},s=t._messageBus.postMessage(n);t._messageBus.addResponseListener(t._idmURL,s,function(e){if(t._messageBus.removeResponseListener(t._idmURL,s),200===e.body.code){var n=e.body.value;console.log("selectedIdentity: ",n.identity),r(n)}else o("error on requesting an identity to the GUI")})})}},{key:"getIdentities",value:function(){var e=this;return e.identities}},{key:"getIdentity",value:function(e){var t=this;for(var r in t.identities){var o=t.identities[r];if(o.identity===e)return o}throw"identity not found"}},{key:"getIdentityOfHyperty",value:function(e){var t=this;return new _promise2.default(function(r,o){var n=e.split("://");if("hyperty"!==n[0])t._getHypertyFromDataObject(e).then(function(e){var n=t.registry.getHypertyOwner(e);if(!n)return o("no identity was found ");for(var s in t.identities){var a=t.identities[s];if(a.identity===n)return r(a.messageInfo)}});else{var s=t.registry.getHypertyOwner(e);if(!s)return o("no identity was found.");for(var a in t.identities){var i=t.identities[a];if(i.identity===s)return r(i.messageInfo)}}})}},{key:"getUsersIDs",value:function(e){var t=this,r=[],o=e?_utils.getUserEmailFromURL:function(e){return e};for(var n in t.identities){var s=t.identities[n];r.push(o(s.identity))}return r}},{key:"getCurrentIdentity",value:function(){var e=this;return e.currentIdentity}},{key:"setCurrentIdentity",value:function(e){var t=this;t.currentIdentity=e}},{key:"deleteIdentity",value:function(e){var t=this;for(var r in t.identities)t.identities[r].identity===e&&t.identities.splice(r,1)}},{key:"_resolveDomain",value:function(e){return e?"domain-idp://"+e:"domain-idp://google.com"}},{key:"loginWithRP",value:function(e,t){var r=this;return new _promise2.default(function(t,o){r.currentIdentity=void 0,r.getIdentityAssertion("identifier","origin","hint",e).then(function(e){console.log("loginWithRP"),t(e)},function(e){console.log("loginWithRP err"),o(e)})})}},{key:"getIdentityAssertion",value:function(e,t,r,o){var n=this;return new _promise2.default(function(e,r){if(void 0!==n.currentIdentity)return e(n.currentIdentity);try{window&&!function(){var s=void 0,a=void 0;n.crypto.generateRSAKeyPair().then(function(e){return s=btoa(e.public),a=e,n.generateAssertion(s,t,"",a,o)}).then(function(e){return n.generateAssertion(s,t,e,a,o)}).then(function(t){t?e(t):r("Error on obtaining Identity")}).catch(function(e){console.log(e),r(e)})}()}catch(t){console.log("getIdentityAssertion for nodejs");var s=Math.floor(1e4*Math.random()+1),a={assertion:"assertion",idp:"nodejs",userProfile:{avatar:"https://lh3.googleusercontent.com/-WaCrjVMMV-Q/AAAAAAAAAAI/AAAAAAAAAAs/8OlVqCpSB9c/photo.jpg",cn:"test nodejs",username:"nodejs-"+s+"@nodejs.com",userURL:"user://nodejs.com/nodejs-"+s}};return n.currentIdentity=a,n.identities.push(a),e(a)}})}},{key:"generateAssertion",value:function(e,t,r,o,n){var s=this,a=s._resolveDomain(n),i=void 0;return console.log("generateAssertion"),new _promise2.default(function(n,y){i={type:"execute",to:a,from:s._idmURL,body:{resource:"identity",method:"generateAssertion",params:{contents:e,origin:t,usernameHint:r}}},s._messageBus.postMessage(i,function(e){var t=e.body.value;if(t.loginUrl)!function(){var e=window.open(t.loginUrl,"openIDrequest","width=800, height=600");window.cordova?e.addEventListener("loadstart",function(t){var r=t.url,o=/\&code=(.+)$/.exec(r),s=/\&error=(.+)$/.exec(r);(o||s)&&(e.close(),n(r))}):!function(){var t=setInterval(function(){try{if(e.closed&&(y("Some error occured when trying to get identity."),clearInterval(t)),e.document.URL.indexOf("id_token")!==-1||e.document.URL.indexOf(location.origin)!==-1){window.clearInterval(t);var r=e.document.URL;e.close(),n(r)}}catch(e){}},500)}()}();else if(t){var r=JSON.parse(atob(t.assertion)),a=void 0;if(a=r.tokenIDJSON?r.tokenIDJSON:r){t.identity=(0,_utils.getUserURLFromEmail)(a.email),s.identity.addIdentity(t);var i=t.infoToken?t.infoToken:{},c={username:a.email,cn:a.name,avatar:i.picture,locale:i.locale,userURL:(0,_utils.getUserURLFromEmail)(a.email)},d={userProfile:c,idp:t.idp.domain,assertion:t.assertion};t.messageInfo=d,t.keyPair=o,s.currentIdentity=d,s.identities.push(t),n(d)}}else y("error on obtaining identity information")})})}},{key:"validateAssertion",value:function(e,t,r){var o=this,n=o._resolveDomain(r),s={type:"EXECUTE",to:n,from:o._idmURL,body:{resource:"identity",method:"validateAssertion",params:{assertion:e,origin:t}}};return new _promise2.default(function(e,t){o._messageBus.postMessage(s,function(r){200===r.body.code?e(r.body.value):t("error",r.body.code)})})}},{key:"encryptMessage",value:function(e){var t=this;return console.log("encrypt message "),new _promise2.default(function(r,o){var n="handshake"===e.type;if(!t.isToUseEncryption&&!n)return console.log("encryption disabled"),r(e);var s=e.to.split("/"),a=s[0]+"//"+s[2]+"/"+s[3];s.length>6&&(a=s[0]+"//"+s[2]+"/"+s[3]+"/"+s[4]);var i=(0,_utils.isDataObjectURL)(a),y="hyperty"===(0,_utils.divideURL)(e.from).type,c="hyperty"===(0,_utils.divideURL)(e.to).type;if(y&&c){var d=t._registry.getHypertyOwner(e.from);d&&!function(){var s=t.chatKeys[e.from+"<->"+e.to];s||(s=t._newChatCrypto(e,d),console.log("createChatKey encrypt",e.from+e.to),t.chatKeys[e.from+"<->"+e.to]=s,e.body.handshakePhase="startHandShake"),s.authenticated&&!n?!function(){var o=t.crypto.generateIV();t.crypto.encryptAES(s.keys.hypertyFromSessionKey,e.body.value,o).then(function(n){var a=t._filterMessageToHash(e,e.body.value+o,s.hypertyFrom.messageInfo);t.crypto.hashHMAC(s.keys.hypertyFromHashKey,a).then(function(s){var a={iv:t.crypto.encode(o),value:t.crypto.encode(n),hash:t.crypto.encode(s)};e.body.value=btoa((0,_stringify2.default)(a)),r(e)})})}():n?r(e):t._doHandShakePhase(e,s).then(function(r){t.chatKeys[e.from+"<->"+e.to]=r.chatKeys,t._messageBus.postMessage(r.message),o("encrypt handshake protocol phase ")})}()}else y&&i&&!function(){console.log("dataObject value to encrypt: ",e.body.value);var n=t.dataObjectSessionKeys[a];if(!n){var s=t.registry.getReporterURLSynchonous(a);if(s&&s===e.from){var i=t.crypto.generateRandom();t.dataObjectSessionKeys[a]={sessionKey:i,isToEncrypt:!0},n=t.dataObjectSessionKeys[a]}}n?n.isToEncrypt?!function(){var o=t.crypto.generateIV();t.crypto.encryptAES(n.sessionKey,t.crypto.encode((0,_stringify2.default)(e.body.value)),o).then(function(s){var a=t._filterMessageToHash(e,e.body.value+o,n.sessionKey);t.crypto.hashHMAC(n.sessionKey,a).then(function(n){var a=btoa((0,_stringify2.default)({value:t.crypto.encode(s),iv:t.crypto.encode(o),hash:t.crypto.encode(n)}));e.body.value=a,r(e)})})}():r(e):o("failed to decrypt message")}()})}},{key:"decryptMessage",value:function(e){var t=this;return console.log("decrypt message "),new _promise2.default(function(r,o){var n="handshake"===e.type;if(!t.isToUseEncryption&&!n)return console.log("decryption disabled"),r(e);var s=e.to.split("/"),a=s[0]+"//"+s[2]+"/"+s[3];s.length>6&&(a=s[0]+"//"+s[2]+"/"+s[3]+"/"+s[4]);var i=(0,_utils.isDataObjectURL)(a),y="hyperty"===(0,_utils.divideURL)(e.from).type,c="hyperty"===(0,_utils.divideURL)(e.to).type;if(y&&c){var d=t._registry.getHypertyOwner(e.to);d?!function(){var s=t.chatKeys[e.to+"<->"+e.from];s||(s=t._newChatCrypto(e,d,"decrypt"),t.chatKeys[e.to+"<->"+e.from]=s),s.authenticated&&!n?!function(){var o=JSON.parse(atob(e.body.value)),n=t.crypto.decode(o.iv),a=t.crypto.decode(o.value),i=t.crypto.decode(o.hash);t.crypto.decryptAES(s.keys.hypertyToSessionKey,a,n).then(function(o){console.log("decrypted value ",o),e.body.value=o;var a=t._filterMessageToHash(e,o+n);t.crypto.verifyHMAC(s.keys.hypertyToHashKey,a,i).then(function(t){e.body.assertedIdentity=!0,r(e)})})}():n?t._doHandShakePhase(e,s).then(function(r){"handShakeEnd"===r?o("decrypt handshake protocol phase "):(t.chatKeys[e.to+"<->"+e.from]=r.chatKeys,t._messageBus.postMessage(r.message),o("decrypt handshake protocol phase "))}):o("wrong message do decrypt")}():o("error on decrypt message")}else y&&i?!function(){console.log("dataObject value to decrypt: ",e.body);var o=t.dataObjectSessionKeys[a];o&&o.isToEncrypt?!function(){var n=JSON.parse(atob(e.body.value)),s=t.crypto.decode(n.iv),a=t.crypto.decode(n.value),i=t.crypto.decode(n.hash);t.crypto.decryptAES(o.sessionKey,a,s).then(function(n){var a=JSON.parse(atob(n));console.log("decrypted Value,",a),e.body.value=a;var y=t._filterMessageToHash(e,a+s);t.crypto.verifyHMAC(o.sessionKey,y,i).then(function(t){e.body.assertedIdentity=!0,r(e)})})}():(e.body.assertedIdentity=!0,r(e))}():o("wrong message to decrypt")})}},{key:"doMutualAuthentication",value:function(e,t){console.log("doMutualAuthentication: ",e,t);var r=this,o=void 0,n=r.registry.getReporterURLSynchonous(e);n&&(o=e,e=n);var s={to:t,from:e,callback:void 0,body:{handshakePhase:"startHandShake",ignore:"ignoreMessage"}};return new _promise2.default(function(n,a){if(!e||!t)return a("sender or receiver missing on doMutualAuthentication");var i=r.chatKeys[e+"<->"+t],y=r._registry.getHypertyOwner(e);if(y){if(!i){var c=function(e){console.log("callback value:",e),n(e)};s.callback=c,s.dataObjectURL=o,i=r._newChatCrypto(s,y),r.chatKeys[e+"<->"+t]=i}if(i.authenticated){var d={to:e,from:t};i.dataObjectURL=o,r._sendReporterSessionKey(d,i).then(function(e){r._messageBus.postMessage(e.message),n("exchange of chat sessionKey initiated")})}else r._doHandShakePhase(s,i)}else a("error on doMutualAuthentication")})}},{key:"_doHandShakePhase",value:function(e,t){var r=this;return new _promise2.default(function(o,n){var s=e.body.handshakePhase,a=void 0,i=void 0,y={},c=void 0;!function(){switch(s){case"startHandShake":t.keys.fromRandom=r.crypto.generateRandom();var d={type:"handshake",to:e.to,from:e.from,body:{handshakePhase:"senderHello",value:r.crypto.encode(t.keys.fromRandom)}};t.handshakeHistory.senderHello=r._filterMessageToHash(d,void 0,t.hypertyFrom.messageInfo),t.initialMessage?o({message:d,chatKeys:t}):(r.chatKeys[e.from+"<->"+e.to]=t,r._messageBus.postMessage(d));break;case"senderHello":console.log("senderHello"),t.handshakeHistory.senderHello=r._filterMessageToHash(e),t.keys.fromRandom=r.crypto.decode(e.body.value),t.keys.toRandom=r.crypto.generateRandom();var u={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"receiverHello",value:r.crypto.encode(t.keys.toRandom)}};t.handshakeHistory.receiverHello=r._filterMessageToHash(u,void 0,t.hypertyFrom.messageInfo),o({message:u,chatKeys:t});break;case"receiverHello":console.log("receiverHello"),t.handshakeHistory.receiverHello=r._filterMessageToHash(e),r.validateAssertion(e.body.identity.assertion).then(function(o){var n=r.crypto.decode(o.contents.nonce),s=r.crypto.generatePMS(),a=e.body.value;t.hypertyTo.assertion=e.body.identity.assertion,t.hypertyTo.publicKey=n,t.hypertyTo.userID=o.contents.email,t.keys.toRandom=r.crypto.decode(a),t.keys.premasterKey=s;var i=r.crypto.concatPMSwithRandoms(s,t.keys.toRandom,t.keys.fromRandom);return r.crypto.generateMasterSecret(i,"messageHistoric"+t.keys.toRandom+t.keys.fromRandom)}).then(function(e){return t.keys.masterKey=e,r.crypto.generateKeys(e,"key expansion"+t.keys.toRandom+t.keys.fromRandom)}).then(function(o){t.keys.hypertyToSessionKey=new Uint8Array(o[0]),t.keys.hypertyFromSessionKey=new Uint8Array(o[1]),t.keys.hypertyToHashKey=new Uint8Array(o[2]),t.keys.hypertyFromHashKey=new Uint8Array(o[3]),a=r.crypto.generateIV(),y.iv=r.crypto.encode(a);var n={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"senderCertificate"}};return c=r._filterMessageToHash(n,"ok"+a,t.hypertyFrom.messageInfo),r.crypto.hashHMAC(t.keys.hypertyFromHashKey,c)}).then(function(e){return y.hash=r.crypto.encode(e),r.crypto.encryptAES(t.keys.hypertyFromSessionKey,"ok",a)}).then(function(e){return y.symetricEncryption=r.crypto.encode(e),r.crypto.encryptRSA(t.hypertyTo.publicKey,t.keys.premasterKey)}).then(function(o){y.assymetricEncryption=r.crypto.encode(o);var n={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"senderCertificate"}},s=r._filterMessageToHash(n,t.keys.premasterKey,t.hypertyFrom.messageInfo);return r.crypto.signRSA(t.hypertyFrom.privateKey,(0,_stringify2.default)(t.handshakeHistory)+(0,_stringify2.default)(s))}).then(function(n){y.signature=r.crypto.encode(n);var s={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"senderCertificate",value:btoa((0,_stringify2.default)(y))}};t.handshakeHistory.senderCertificate=r._filterMessageToHash(s,"ok"+a,t.hypertyFrom.messageInfo),o({message:s,chatKeys:t})},function(e){return n(e)});break;case"senderCertificate":console.log("senderCertificate");var h=JSON.parse(atob(e.body.value));r.validateAssertion(e.body.identity.assertion).then(function(o){var n=r.crypto.decode(h.assymetricEncryption),s=r.crypto.decode(o.contents.nonce);return t.hypertyTo.assertion=e.body.identity.assertion,t.hypertyTo.publicKey=s,t.hypertyTo.userID=o.contents.email,r.crypto.decryptRSA(t.hypertyFrom.privateKey,n)},function(e){console.log(e),n("Error during authentication of identity")}).then(function(o){t.keys.premasterKey=new Uint8Array(o);var n=r.crypto.decode(h.signature),s=r._filterMessageToHash(e,t.keys.premasterKey);return r.crypto.verifyRSA(t.hypertyTo.publicKey,(0,_stringify2.default)(t.handshakeHistory)+(0,_stringify2.default)(s),n)}).then(function(e){console.log("signature validation result ",e);var o=r.crypto.concatPMSwithRandoms(t.keys.premasterKey,t.keys.toRandom,t.keys.fromRandom);return r.crypto.generateMasterSecret(o,"messageHistoric"+t.keys.toRandom+t.keys.fromRandom)}).then(function(e){return t.keys.masterKey=e,r.crypto.generateKeys(e,"key expansion"+t.keys.toRandom+t.keys.fromRandom)}).then(function(e){t.keys.hypertyFromSessionKey=new Uint8Array(e[0]),t.keys.hypertyToSessionKey=new Uint8Array(e[1]),t.keys.hypertyFromHashKey=new Uint8Array(e[2]),t.keys.hypertyToHashKey=new Uint8Array(e[3]),a=r.crypto.decode(h.iv);var o=r.crypto.decode(h.symetricEncryption);return r.crypto.decryptAES(t.keys.hypertyToSessionKey,o,a)}).then(function(o){t.handshakeHistory.senderCertificate=r._filterMessageToHash(e,o+a);var n=r.crypto.decode(h.hash);return c=r._filterMessageToHash(e,o+a),r.crypto.verifyHMAC(t.keys.hypertyToHashKey,c,n)}).then(function(o){var n={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"receiverFinishedMessage"}};return a=r.crypto.generateIV(),y.iv=r.crypto.encode(a),c=r._filterMessageToHash(n,"ok!"+a,t.hypertyFrom.messageInfo),r.crypto.hashHMAC(t.keys.hypertyFromHashKey,n)}).then(function(e){return y.hash=r.crypto.encode(e),r.crypto.encryptAES(t.keys.hypertyFromSessionKey,"ok!",a)}).then(function(n){y.value=r.crypto.encode(n);var s={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"receiverFinishedMessage",value:btoa((0,_stringify2.default)(y))}};t.handshakeHistory.receiverFinishedMessage=r._filterMessageToHash(s,"ok!"+a,t.hypertyFrom.messageInfo),t.authenticated=!0,o({message:s,chatKeys:t})});break;case"receiverFinishedMessage":console.log("receiverFinishedMessage"),t.authenticated=!0,y=JSON.parse(atob(e.body.value)),a=r.crypto.decode(y.iv);var l=r.crypto.decode(y.value);i=r.crypto.decode(y.hash),r.crypto.decryptAES(t.keys.hypertyToSessionKey,l,a).then(function(n){console.log("decryptedData",n),t.handshakeHistory.receiverFinishedMessage=r._filterMessageToHash(e,n+a);var s=r._filterMessageToHash(e,l+a);r.crypto.verifyHMAC(t.keys.hypertyToHashKey,s,i).then(function(n){if(console.log("hash result",n),t.initialMessage){var s={type:"create",to:e.from,from:e.to,body:{value:t.initialMessage.body.value}};o({message:s,chatKeys:t})}else r._sendReporterSessionKey(e,t).then(function(e){o(e)})})});break;case"reporterSessionKey":console.log("reporterSessionKey");var p=JSON.parse(atob(e.body.value));i=r.crypto.decode(p.hash),a=r.crypto.decode(p.iv);var f=r.crypto.decode(p.value),v=void 0,m=void 0,g=void 0,k=void 0;r.crypto.decryptAES(t.keys.hypertyToSessionKey,f,a).then(function(o){v=JSON.parse(o),m=r.crypto.decode(v.value),g=v.dataObjectURL;var n=r._filterMessageToHash(e,o+a);return r.crypto.verifyHMAC(t.keys.hypertyToHashKey,n,i)}).then(function(e){return r.dataObjectSessionKeys[g]={sessionKey:m,isToEncrypt:!0},a=r.crypto.generateIV(),y.iv=r.crypto.encode(a),r.crypto.encryptAES(t.keys.hypertyFromSessionKey,"ok!!",a)}).then(function(o){k={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"receiverAcknowledge"}},y.value=r.crypto.encode(o);var n=r._filterMessageToHash(k,"ok!!"+a,t.hypertyFrom.messageInfo);return r.crypto.hashHMAC(t.keys.hypertyFromHashKey,n)}).then(function(e){var n=btoa((0,_stringify2.default)({value:y.value,hash:r.crypto.encode(e),iv:y.iv}));k.body.value=n,o({message:k,chatKeys:t})});break;case"receiverAcknowledge":console.log("receiverAcknowledge");var _=JSON.parse(atob(e.body.value)),b=r.crypto.decode(_.hash);a=r.crypto.decode(_.iv);var K=r.crypto.decode(_.value);r.crypto.decryptAES(t.keys.hypertyToSessionKey,K,a).then(function(o){var n=r._filterMessageToHash(e,o+a);return r.crypto.verifyHMAC(t.keys.hypertyToHashKey,n,b)}).then(function(e){var r=t.callback;r&&r("handShakeEnd"),o("handShakeEnd")});break;default:n(e)}}()})}},{key:"_sendReporterSessionKey",value:function(e,t){var r=this,o=r.dataObjectSessionKeys[t.dataObjectURL],n=void 0,s=void 0,a=void 0,i=void 0,y={};return new _promise2.default(function(c,d){o?a=o.sessionKey:(a=r.crypto.generateRandom(),r.dataObjectSessionKeys[t.dataObjectURL]={sessionKey:a,isToEncrypt:!0}),s=(0,_stringify2.default)({value:r.crypto.encode(a),dataObjectURL:t.dataObjectURL}),i=r.crypto.generateIV(),y.iv=r.crypto.encode(i),r.crypto.encryptAES(t.keys.hypertyFromSessionKey,s,i).then(function(o){n={type:"handshake",to:e.from,from:e.to,body:{handshakePhase:"reporterSessionKey",value:r.crypto.encode(o)}};var a=r._filterMessageToHash(n,s+i,t.hypertyFrom.messageInfo);return r.crypto.hashHMAC(t.keys.hypertyFromHashKey,a)}).then(function(e){var o=btoa((0,_stringify2.default)({value:n.body.value,hash:r.crypto.encode(e),iv:y.iv}));n.body.value=o,c({message:n,chatKeys:t})})})}},{key:"_getHypertyFromDataObject",value:function(e){var t=this;return new _promise2.default(function(r,o){var n=e.split("/"),s=n[0]+"//"+n[2]+"/"+n[3];n.length>6&&(s=n[0]+"//"+n[2]+"/"+n[3]+"/"+n[4]);var a=t.registry.getReporterURLSynchonous(s);if(a)r(a);else{var i=t.dataObjectsIdentity[s];if(i)r(i);else{var y=t.registry.getDataObjectSubscriberHyperty(e);y?r(y):t.registry.discoverDataObjectPerURL(s,n[2]).then(function(e){t.dataObjectsIdentity[s]=e.reporter,r(e.reporter)},function(e){o(e)})}}})}},{key:"_filterMessageToHash",value:function(e,t,r){return{type:e.type,from:e.from,to:e.to,body:{identity:r||e.body.identity,value:t||e.body.value,handshakePhase:e.body.handshakePhase}}}},{key:"_newChatCrypto",value:function(e,t,r){var o=this,n=r?e.to:e.from,s=r?e.from:e.to,a=o.getIdentity(t),i={hypertyFrom:{hyperty:n,userID:a.messageInfo.userProfile.username,privateKey:a.keyPair.private,publicKey:a.keyPair.public,assertion:a.assertion,messageInfo:a.messageInfo},hypertyTo:{hyperty:s,userID:void 0,publicKey:void 0,assertion:void 0},keys:{hypertyToSessionKey:void 0,hypertyFromSessionKey:void 0,hypertyToHashKey:void 0,hypertyFromHashKey:void 0,toRandom:void 0,fromRandom:void 0,premasterKey:void 0,masterKey:void 0},handshakeHistory:{senderHello:void 0,receiverHello:void 0,senderCertificate:void 0,receiverFinishedMessage:void 0},initialMessage:e.body.ignore?void 0:e,callback:e.callback,authenticated:!1,dataObjectURL:e.dataObjectURL};return i}},{key:"messageBus",get:function(){var e=this;return e._messageBus},set:function(e){var t=this;t._messageBus=e;var r=new _GuiFake2.default(t._guiURL,t._messageBus);t.guiFake=r}},{key:"registry",get:function(){var e=this;return e._registry},set:function(e){var t=this;t._registry=e}}]),e}();exports.default=IdentityModule,module.exports=exports.default;
//# sourceMappingURL=IdentityModule.js.map
