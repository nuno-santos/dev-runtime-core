"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),_CommonCtx2=require("./CommonCtx"),_CommonCtx3=_interopRequireDefault(_CommonCtx2),_Condition=require("../conditions/Condition"),_Condition2=_interopRequireDefault(_Condition),_utils=require("../../utils/utils"),_PersistenceManager=require("service-framework/dist/PersistenceManager"),_PersistenceManager2=_interopRequireDefault(_PersistenceManager),_Rule=require("../Rule"),_Rule2=_interopRequireDefault(_Rule),_UserPolicy=require("../policies/UserPolicy"),_UserPolicy2=_interopRequireDefault(_UserPolicy),_SubscriptionCondition=require("../conditions/SubscriptionCondition"),_SubscriptionCondition2=_interopRequireDefault(_SubscriptionCondition),RuntimeCoreCtx=function(e){function i(e,t){(0,_classCallCheck3.default)(this,i);var r=(0,_possibleConstructorReturn3.default)(this,(0,_getPrototypeOf2.default)(i).call(this));return r.idModule=e,r.runtimeRegistry=t,r.activeUserPolicy=void 0,r.serviceProviderPolicies={},r.userPolicies={},r}return(0,_inherits3.default)(i,e),(0,_createClass3.default)(i,[{key:"authorise",value:function(e){var i=this;return new _promise2.default(function(t,r){console.log("--- Policy Engine ---"),console.log(e),e.body=e.body||{};var o=void 0,s=i._isToVerify(e),n=i._isIncomingMessage(e),u=i._isToCypherModule(e);if(s)if(n)if(u)i.decrypt(e).then(function(e){var s={serviceProviderPolicy:i.getServiceProviderPolicy(e,n),userPolicy:i.activeUserPolicy};if(o=i.policyEngine.pdp.applyPolicies(e,s),i.policyEngine.pep.enforcePolicies(e,s,o),"Not Applicable"===o&&(o=i.defaultBehavior,e.body.auth=!1),o){var u="subscribe"===e.type,a=i.isFromRemoteSM(e.from);u&a&&(i.registerSubscriber(e),i.doMutualAuthentication(e)),e.body.auth=void 0===e.body.auth||e.body.auth,t(e)}else r("Message blocked")},function(e){r(e)});else{var a={serviceProviderPolicy:i.getServiceProviderPolicy(e,n),userPolicy:i.activeUserPolicy};if(o=i.policyEngine.pdp.applyPolicies(e,a),i.policyEngine.pep.enforcePolicies(e,a,o),"Not Applicable"===o&&(o=i.defaultBehavior,e.body.auth=!1),o){var c="subscribe"===e.type,l=i.isFromRemoteSM(e.from);c&l&&(i.registerSubscriber(e),i.doMutualAuthentication(e)),e.body.auth=void 0===e.body.auth||e.body.auth,t(e)}else r("Message blocked")}else{var d=i._isToSetID(e);if(d)i._getIdentity(e).then(function(s){e.body.identity=s;var a={serviceProviderPolicy:i.getServiceProviderPolicy(e,n),userPolicy:i.activeUserPolicy};o=i.policyEngine.pdp.applyPolicies(e,a),i.policyEngine.pep.enforcePolicies(e,a,o),"Not Applicable"===o&&(o=i.defaultBehavior,e.body.auth=!1),o?(e.body.auth=void 0===e.body.auth||e.body.auth,u?i.encrypt(e).then(function(e){t(e)},function(e){r(e)}):t(e)):r("Message blocked")},function(e){r(e)});else{var y={serviceProviderPolicy:i.getServiceProviderPolicy(e,n),userPolicy:i.activeUserPolicy};o=i.policyEngine.pdp.applyPolicies(e,y),i.policyEngine.pep.enforcePolicies(e,y,o),"Not Applicable"===o&&(o=i.defaultBehavior,e.body.auth=!1),o?(e.body.auth=void 0===e.body.auth||e.body.auth,t(e)):r("Message blocked")}}else o=i.defaultBehavior,e.body.auth=!1,o?t(e):r("Message blocked")})}},{key:"decrypt",value:function(e){var i=this;return new _promise2.default(function(t,r){i.idModule.decryptMessage(e).then(function(e){t(e)},function(e){r(e)})})}},{key:"doMutualAuthentication",value:function(e){var i=e.to.split("/"),t=i.indexOf("subscription"),r=t!==-1,o=this.isFromRemoteSM(e.from);if(r&o){i.pop();var s=i[0]+"//"+i[2]+"/"+i[3];i.length>4&&(s=i[0]+"//"+i[2]+"/"+i[3]+"/"+i[4]),this.idModule.doMutualAuthentication(s,e.body.subscriber)}}},{key:"encrypt",value:function(e){var i=this;return new _promise2.default(function(t,r){i.idModule.encryptMessage(e).then(function(e){t(e)},function(e){r(e)})})}},{key:"getMyEmails",value:function(){var e=this.idModule.getIdentities(),i=[];for(var t in e)i.push((0,_utils.getUserEmailFromURL)(e[t].identity));return i}},{key:"getMyHyperties",value:function(){var e=this.runtimeRegistry.hypertiesList,i=[];for(var t in e){var r=e[t].objectName;i.indexOf(r)===-1&&i.push(r)}return i}},{key:"getServiceProviderPolicy",value:function(e,i){var t=void 0;if(i){var r=this.runtimeRegistry.getHypertyName(e.to);t=this.serviceProviderPolicies[r]}else{var o=this.runtimeRegistry.getHypertyName(e.from);t=this.serviceProviderPolicies[o]}return t}},{key:"isFromRemoteSM",value:function(e){var i=e.split("://");return"runtime"===i[0]&&e!==this.runtimeRegistry.runtimeURL+"/sm"}},{key:"_isToSetID",value:function(e){var i=["domain-idp","runtime","domain"],t=e.from.split("://"),r=t[0];return i.indexOf(r)===-1}},{key:"_isIncomingMessage",value:function(e){return!!e.body.identity}},{key:"getURL",value:function(e){var i=e.split("/");return i[0]+"//"+i[2]+"/"+i[3]}},{key:"_getIdentity",value:function(e){return"update"===e.type?this.idModule.getIdentityOfHyperty(e.body.source):"response"===e.type&&void 0!==e.body.source?this.idModule.getIdentityOfHyperty(e.body.source):"hyperty"===(0,_utils.divideURL)(e.from).type?this.idModule.getIdentityOfHyperty(e.from):this.idModule.getIdentityOfHyperty(this.getURL(e.from))}},{key:"_isToVerify",value:function(e){var i=["domain-idp","hyperty-runtime","runtime","domain"],t=e.from.split("://"),r=t[0],o=e.to.split("://"),s=o[0];return r!==e.from&&s!==e.to&&(i.indexOf(r)===-1||i.indexOf(s)===-1)}},{key:"_isToCypherModule",value:function(e){var i="create"===e.type,t="hyperty"===(0,_utils.divideURL)(e.from).type,r="hyperty"===(0,_utils.divideURL)(e.to).type,o=(0,_utils.isDataObjectURL)(e.to),s="handshake"===e.type;return i&&t&&r||i&&t&&o||s}},{key:"loadActivePolicy",value:function(){this.activeUserPolicy=_PersistenceManager2.default.get("rethink:activePolicy")}},{key:"loadGroups",value:function(){var e=_PersistenceManager2.default.get("rethink:groups");void 0!=e&&(this.groups=e)}},{key:"loadSPPolicies",value:function(){var e=_PersistenceManager2.default.get("rethink:spPolicies");void 0!==e&&(this.serviceProviderPolicies=e)}},{key:"loadUserPolicies",value:function(){var e=_PersistenceManager2.default.get("rethink:userPolicies");if(void 0!==e)for(var i in e){var t=[],r=e[i].rules;for(var o in r){var s=void 0;s="subscription"===r[o].condition.attribute?new _SubscriptionCondition2.default(r[o].condition.attribute,r[o].condition.operator,r[o].condition.params):new _Condition2.default(r[o].condition.attribute,r[o].condition.operator,r[o].condition.params),t.push(new _Rule2.default(r[o].authorise,s,r[o].priority,r[o].scope,r[o].target))}this.userPolicies[i]=new _UserPolicy2.default(e[i].key,t,e[i].actions,e[i].combiningAlgorithm)}}},{key:"registerSubscriber",value:function(e){var i=e.to.split("/"),t=i.indexOf("subscription"),r=t!==-1,o=this.isFromRemoteSM(e.from);if(r&o){i.pop();var s=i[0]+"//"+i[2]+"/"+i[3];i.length>4&&(s=i[0]+"//"+i[2]+"/"+i[3]+"/"+i[4]),this.runtimeRegistry.registerSubscriber(s,e.body.subscriber)}}},{key:"_getLastComponentOfURL",value:function(e){var i=e.split("/");return i[i.length-1]}},{key:"saveActivePolicy",value:function(){_PersistenceManager2.default.set("rethink:activePolicy",0,this.activeUserPolicy)}},{key:"saveGroups",value:function(){_PersistenceManager2.default.set("rethink:groups",0,this.groups)}},{key:"savePolicies",value:function(e){switch(e){case"USER":_PersistenceManager2.default.set("rethink:userPolicies",0,this.userPolicies);break;case"SERVICE_PROVIDER":_PersistenceManager2.default.set("rethink:spPolicies",0,this.serviceProviderPolicies)}}},{key:"dataObjectScheme",get:function(){return this._dataObjectScheme},set:function(e){var i=e.message.from;(0,_utils.isDataObjectURL)(i)?this._dataObjectScheme=(0,_utils.divideURL)(i).type:this._dataObjectScheme=void 0}},{key:"subscription",get:function(){return this._subscription},set:function(e){this._subscription=e.message.body.subscriber}}]),i}(_CommonCtx3.default);exports.default=RuntimeCoreCtx,module.exports=exports.default;
//# sourceMappingURL=RuntimeCoreCtx.js.map
