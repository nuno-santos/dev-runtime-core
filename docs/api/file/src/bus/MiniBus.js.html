<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/bus/MiniBus.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="git+ssh://git@github.com:reTHINK-project/dev-runtime-core.git">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">bus</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/MessageBus.js~MessageBus.html">MessageBus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/MiniBus.js~MiniBus.html">MiniBus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/Pipeline.js~Pipeline.html">Pipeline</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">graphconnector</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/BloomFilter.js~BloomFilter.html">BloomFilter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/GlobalRegistryRecord.js~GlobalRegistryRecord.html">GlobalRegistryRecord</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/GraphConnector.js~GraphConnector.html">GraphConnector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/GraphConnectorContactData.js~GraphConnectorContactData.html">GraphConnectorContactData</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">identity</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/identity/IdentityModule.js~IdentityModule.html">IdentityModule</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">persistence</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-persistenceManager">persistenceManager</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">policy</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/PolicyEngine.js~PolicyEngine.html">PolicyEngine</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">protostub</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-activate">activate</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">registry</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/AddressAllocation.js~AddressAllocation.html">AddressAllocation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/HypertyDiscovery.js~HypertyDiscovery.html">HypertyDiscovery</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/HypertyInstance.js~HypertyInstance.html">HypertyInstance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/Registry.js~Registry.html">Registry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/RegistryDataModel.js~RegistryDataModel.html">RegistryDataModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">runtime</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/runtime/RuntimeCatalogue-Local.js~RuntimeCatalogue.html">RuntimeCatalogue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/runtime/RuntimeCatalogue.js~RuntimeCatalogue.html">RuntimeCatalogue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/runtime/RuntimeUA.js~RuntimeUA.html">RuntimeUA</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">sandbox</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/sandbox/Sandbox.js~Sandbox.html">Sandbox</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/sandbox/SandboxRegistry.js~SandboxRegistry.html">SandboxRegistry</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">syncher</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/syncher/ObjectAllocation.js~ObjectAllocation.html">ObjectAllocation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/syncher/SyncherManager.js~SyncherManager.html">SyncherManager</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/EventEmitter.js~EventEmitter.html">EventEmitter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-deepClone">deepClone</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-divideURL">divideURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-emptyObject">emptyObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-divideURL">divideURL</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/bus/MiniBus.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import Pipeline from &apos;./Pipeline&apos;;

/**
* @author micaelpedrosa@gmail.com
* Minimal interface and implementation to send and receive messages. It can be reused in many type of components.
* Components that need a message system should receive this class as a dependency or extend it.
* Extensions should implement the following private methods: _onPostMessage and _registerExternalListener
*/
class MiniBus {
  /* private
  _msgId: number;
  _subscriptions: &lt;url: MsgListener[]&gt;

  _responseTimeOut: number
  _responseCallbacks: &lt;url+id: (msg) =&gt; void&gt;

  _pipeline: Pipeline
  */

  constructor() {
    let _this = this;
    _this._msgId = 0;
    _this._subscriptions = {};

    _this._responseTimeOut = 5000; //default to 3s
    _this._responseCallbacks = {};

    _this._pipeline = new Pipeline((error) =&gt; {
      console.log(&apos;PIPELINE-ERROR: &apos;, JSON.stringify(error));
    });

    _this._registerExternalListener();
  }

  get pipeline() { return this._pipeline; }

  /**
  * Register listener to receive message when &quot;msg.to === url&quot;.
  * Special url &quot;*&quot; for default listener is accepted to intercept all messages.
  * @param {URL} url Address to intercept, tha is in the message &quot;to&quot;
  * @param {Listener} listener listener
  * @return {MsgListener} instance of MsgListener
  */
  addListener(url, listener) {
    let _this = this;

    let item = new MsgListener(_this._subscriptions, url, listener);
    let itemList = _this._subscriptions[url];
    if (!itemList) {
      itemList = [];
      _this._subscriptions[url] = itemList;
    }

    itemList.push(item);
    return item;
  }

  /**
   * Manually add a response listener. Only one listener per message ID should exist.
   * ATENTION, there is no timeout for this listener.
   * The listener should be removed with a removeResponseListener, failing to do this will result in a unreleased memory problem.
   * @param {URL} url Origin address of the message sent, &quot;msg.from&quot;.
   * @param {number} msgId Message ID that is returned from the postMessage.
   * @param {Function} responseListener Callback function for the response
   */
  addResponseListener(url, msgId, responseListener) {
    this._responseCallbacks[url + msgId] = responseListener;
  }

  /**
   * Remove the response listener.
   * @param {URL} url Origin address of the message sent, &quot;msg.from&quot;.
   * @param {number} msgId  Message ID that is returned from the postMessage
   */
  removeResponseListener(url, msgId) {
    delete this._responseCallbacks[url + msgId];
  }

  /**
   * Remove all existent listeners for the URL
   * @param  {URL} url Address registered
   */
  removeAllListenersOf(url) {
    delete this._subscriptions[url];
  }

  /**
  * Send messages to local listeners, or if not exists to external listeners.
  * It&apos;s has an optional mechanism for automatic management of response handlers.
  * The response handler will be unregistered after receiving the response, or after response timeout (default to 3s).
  * @param  {Message} msg Message to send. Message ID is automatically added to the message.
  * @param  {Function} responseCallback Optional parameter, if the developer what&apos;s automatic response management.
  * @return {number} Returns the message ID, in case it should be needed for manual management of the response handler.
  */
  postMessage(inMsg, responseCallback) {
    let _this = this;

    //TODO: how do we manage message ID&apos;s? Should it be a global runtime counter, or per URL address?
    //Global counter will not work, because there will be multiple MiniBus instances!
    //Per URL, can be a lot of data to maintain!
    //Maybe a counter per MiniBus instance. This is the assumed solution for now.
    if (!inMsg.id || inMsg.id === 0) {
      _this._msgId++;
      inMsg.id = _this._msgId;
    }

    _this._pipeline.process(inMsg, (msg) =&gt; {

      //automatic management of response handlers
      if (responseCallback) {
        let responseId = msg.from + msg.id;
        _this._responseCallbacks[responseId] = responseCallback;

        setTimeout(() =&gt; {
          let responseFun = _this._responseCallbacks[responseId];
          delete _this._responseCallbacks[responseId];

          if (responseFun) {
            let errorMsg = {
              id: msg.id, type: &apos;response&apos;,
              body: { code: 408, desc: &apos;Response timeout!&apos;, value: inMsg }
            };

            responseFun(errorMsg);
          }
        }, _this._responseTimeOut);
      }

      if (!_this._onResponse(msg)) {
        let itemList = _this._subscriptions[msg.to];
        if (itemList) {
          //do not publish on default address, because of loopback cycle
          _this._publishOn(itemList, msg);
        } else {
          //if there is no listener, send to external interface
          _this._onPostMessage(msg);
        }
      }
    });

    return inMsg.id;
  }

  /**
   * Helper method to bind listeners (in both directions) into other MiniBus target.
   * @param  {URL} outUrl Outbound URL, register listener for url in direction &quot;this -&gt; target&quot;
   * @param  {URL} inUrl Inbound URL, register listener for url in direction &quot;target -&gt; this&quot;
   * @param  {MiniBus} target The other target MiniBus
   * @return {Bound} an object that contains the properties [thisListener, targetListener] and the unbind method.
   */
  bind(outUrl, inUrl, target) {
    let _this = this;

    let thisListn = _this.addListener(outUrl, (msg) =&gt; {
      target.postMessage(msg);
    });

    let targetListn = target.addListener(inUrl, (msg) =&gt; {
      _this.postMessage(msg);
    });

    return {
      thisListener: thisListn,
      targetListener: targetListn,
      unbind: () =&gt; {
        this.thisListener.remove();
        this.targetListener.remove();
      }
    };
  }

  //publish on a subscription list.
  _publishOn(itemList, msg) {
    itemList.forEach((sub) =&gt; {
      sub._callback(msg);
    });
  }

  _onResponse(msg) {
    let _this = this;

    if (msg.type === &apos;response&apos;) {
      let responseId = msg.to + msg.id;
      let responseFun = _this._responseCallbacks[responseId];

      //if it&apos;s a provisional response, don&apos;t delete response listener
      if (msg.body.code &gt;= 200) {
        delete _this._responseCallbacks[responseId];
      }

      if (responseFun) {
        responseFun(msg);
        return true;
      }
    }

    return false;
  }

  //receive messages from external interface
  _onMessage(msg) {
    let _this = this;

    if (!_this._onResponse(msg)) {
      let itemList = _this._subscriptions[msg.to];
      if (itemList) {
        _this._publishOn(itemList, msg);
      } else {
        //is there any &quot;*&quot; (default) listeners?
        itemList = _this._subscriptions[&apos;*&apos;];
        if (itemList) {
          _this._publishOn(itemList, msg);
        }
      }
    }
  }

  /**
   * Not public available, used by the class extension implementation, to process messages from the public &quot;postMessage&quot; without a registered listener.
   * Used to send the message to an external interface, like a WebWorker, IFrame, etc.
   * @param  {Message.Message} msg Message
   */
  _onPostMessage(msg) { /*implementation will send message to external system*/ }

  /**
   * Not public available, used by the class extension implementation, to process all messages that enter the MiniBus from an external interface, like a WebWorker, IFrame, etc.
   * This method is called one time in the constructor to register external listeners.
   * The implementation will probably call the &quot;_onMessage&quot; method to publish in the local listeners.
   * DO NOT call &quot;postMessage&quot;, there is a danger that the message enters in a cycle!
   */
  _registerExternalListener() { /*implementation will register external listener and call &quot;this._onMessage(msg)&quot; */ }

}

class MsgListener {
  /* private
  _subscriptions: &lt;string: MsgListener[]&gt;;
  _url: string;
  _callback: (msg) =&gt; void;
  */

  constructor(subscriptions, url, callback) {
    let _this = this;

    _this._subscriptions = subscriptions;
    _this._url = url;
    _this._callback = callback;
  }

  get url() { return this._url; }

  remove() {
    let _this = this;

    let subs = _this._subscriptions[_this._url];
    if (subs) {
      let index = subs.indexOf(_this);
      subs.splice(index, 1);

      //if there are no listeners, remove the subscription entirely.
      if (subs.length === 0) {
        delete _this._subscriptions[_this._url];
      }
    }
  }
}

export default MiniBus;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.4)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
