<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/runtime/RuntimeCatalogue-Local.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="git+ssh://git@github.com:reTHINK-project/dev-runtime-core.git">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">bus</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/MessageBus.js~MessageBus.html">MessageBus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/MiniBus.js~MiniBus.html">MiniBus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/Pipeline.js~Pipeline.html">Pipeline</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">graphconnector</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/BloomFilter.js~BloomFilter.html">BloomFilter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/GlobalRegistryRecord.js~GlobalRegistryRecord.html">GlobalRegistryRecord</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/GraphConnector.js~GraphConnector.html">GraphConnector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/GraphConnectorContactData.js~GraphConnectorContactData.html">GraphConnectorContactData</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">identity</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/identity/IdentityModule.js~IdentityModule.html">IdentityModule</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">persistence</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-persistenceManager">persistenceManager</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">policy</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/PolicyEngine.js~PolicyEngine.html">PolicyEngine</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">protostub</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-activate">activate</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">registry</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/AddressAllocation.js~AddressAllocation.html">AddressAllocation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/HypertyDiscovery.js~HypertyDiscovery.html">HypertyDiscovery</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/HypertyInstance.js~HypertyInstance.html">HypertyInstance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/Registry.js~Registry.html">Registry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/RegistryDataModel.js~RegistryDataModel.html">RegistryDataModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">runtime</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/runtime/RuntimeCatalogue-Local.js~RuntimeCatalogue.html">RuntimeCatalogue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/runtime/RuntimeCatalogue.js~RuntimeCatalogue.html">RuntimeCatalogue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/runtime/RuntimeUA.js~RuntimeUA.html">RuntimeUA</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">sandbox</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/sandbox/Sandbox.js~Sandbox.html">Sandbox</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/sandbox/SandboxRegistry.js~SandboxRegistry.html">SandboxRegistry</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">syncher</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/syncher/ObjectAllocation.js~ObjectAllocation.html">ObjectAllocation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/syncher/SyncherManager.js~SyncherManager.html">SyncherManager</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/EventEmitter.js~EventEmitter.html">EventEmitter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-deepClone">deepClone</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-divideURL">divideURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-emptyObject">emptyObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-divideURL">divideURL</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/runtime/RuntimeCatalogue-Local.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import {divideURL} from &apos;../utils/utils&apos;;
import {CatalogueFactory} from &apos;service-framework&apos;;
import {HypertyDescriptor, ProtocolStubDescriptor, SourcePackage} from &apos;service-framework&apos;;

class RuntimeCatalogue {

  constructor() {
    // console.log(&apos;runtime catalogue&apos;);
    let _this = this;
    _this._factory = new CatalogueFactory(false, undefined);
  }

  // TODO: Delete this
  mockupHypertyDescriptor() {
    let _this = this;

    // TODO: Remove the code is only for development fase without the Server backend catalogue;
    // Mockup load the base of descriptors
    _this._makeLocalRequest(&apos;../resources/descriptors/Hyperties.json&apos;).then(function(result) {
      _this.Hyperties = JSON.parse(result);
    });
  }

  // TODO: Delete this
  mockupStubDescriptor() {
    let _this = this;

    // TODO: Remove the code is only for development fase without the Server backend catalogue;
    // Mockup load the base of descriptors
    _this._makeLocalRequest(&apos;../resources/descriptors/ProtoStubs.json&apos;).then(function(result) {
      _this.ProtoStubs = JSON.parse(result);
    });
  }

  mockupDataSchemaDescriptor() {
    let _this = this;

    // TODO: Remove the code is only for development fase without the Server backend catalogue;
    // Mockup load the base of descriptors
    _this._makeLocalRequest(&apos;../resources/descriptors/DataSchemas.json&apos;).then(function(result) {
      _this.DataSchemas = JSON.parse(result);
    });
  }

  set runtimeURL(runtimeURL) {
    let _this = this;
    _this._runtimeURL = runtimeURL;

    // TODO: Delete this
    _this.mockupHypertyDescriptor();
    _this.mockupStubDescriptor();
    _this.mockupDataSchemaDescriptor();
  }

  get runtimeURL() {
    let _this = this;
    return _this._runtimeURL;
  }

  /**
  * Get hypertyRuntimeURL
  */
  getHypertyRuntimeURL() {
    let _this = this;

    // TODO: check if this is real needed;
    return _this._hypertyRuntimeURL;
  }

  /**
  * TODO: Delete this method
  */
  _makeLocalRequest(url) {

    return new Promise(function(resolve, reject) {
      let protocolmap = {
        &apos;hyperty-catalogue://&apos;: &apos;http://&apos;,
        &apos;../&apos;: &apos;../&apos;
      };

      let foundProtocol = false;
      for (let protocol in protocolmap) {
        if (url.slice(0, protocol.length) === protocol) {
          // console.log(&apos;exchanging &apos; + protocol + &quot; with &quot; + protocolmap[protocol]);
          url = protocolmap[protocol] + url.slice(protocol.length, url.length);
          foundProtocol = true;
          break;
        }
      }

      if (!foundProtocol) {
        reject(&apos;Invalid protocol of url: &apos; + url);
        return;
      }

      let xhr = new XMLHttpRequest();

      // console.log(url);

      xhr.open(&apos;GET&apos;, url, true);

      xhr.onreadystatechange = function(event) {
        let xhr = event.currentTarget;
        if (xhr.readyState === 4) {
          // console.log(&quot;got response:&quot;, xhr);
          if (xhr.status === 200) {
            resolve(xhr.responseText);
          } else {
            // console.log(&quot;rejecting promise because of response code: 200 != &quot;, xhr.status);
            reject(xhr.responseText);
          }
        }
      };

      xhr.send();

    });

  }

  /**
  * make a http request to a given URL.
  * @param url
  * @returns {Promise}
  * @private
  */
  _makeExternalRequest(url) {
    // console.log(&quot;_makeExternalRequest&quot;, url);

    // TODO: make this request compatible with nodejs
    // at this moment, XMLHttpRequest only is compatible with browser implementation
    // nodejs doesn&apos;t support;
    return new Promise(function(resolve, reject) {
      let protocolmap = {
        &apos;hyperty-catalogue://&apos;: &apos;http://&apos;
      };

      let foundProtocol = false;
      for (let protocol in protocolmap) {
        if (url.slice(0, protocol.length) === protocol) {
          // console.log(&quot;exchanging &quot; + protocol + &quot; with &quot; + protocolmap[protocol]);
          url = protocolmap[protocol] + url.slice(protocol.length, url.length);
          foundProtocol = true;
          break;
        }
      }

      if (!foundProtocol) {
        reject(&apos;Invalid protocol of url: &apos; + url);
        return;
      }

      let xhr = new XMLHttpRequest();

      // console.log(url);

      xhr.open(&apos;GET&apos;, url, true);

      xhr.onreadystatechange = function(event) {
        let xhr = event.currentTarget;
        if (xhr.readyState === 4) {
          // console.log(&quot;got response:&quot;, xhr);
          if (xhr.status === 200) {
            resolve(xhr.responseText);
          } else {
            // console.log(&quot;rejecting promise because of response code: 200 != &quot;, xhr.status);
            reject(xhr.responseText);
          }
        }
      };

      xhr.send();

    });

  }

  /**
  * Get HypertyDescriptor
  * @param hypertyURL - e.g. mydomain.com/.well-known/hyperty/MyHyperty
  * @returns {Promise}
  */
  getHypertyDescriptor(hypertyURL) {
    let _this = this;

    // console.log(&quot;getHypertyDescriptor&quot;, hypertyURL);

    return new Promise(function(resolve, reject) {

      let dividedURL = divideURL(hypertyURL);
      let domain = dividedURL.domain;
      let hyperty = dividedURL.identity;

      if (!domain) {
        domain = hypertyURL;
      }

      if (hyperty) {
        hyperty = hyperty.substring(hyperty.lastIndexOf(&apos;/&apos;) + 1);
      }

      let result = _this.Hyperties[hyperty];

      if (result.error) {
        // TODO handle error properly
        reject(result);
      } else {
        // console.log(&quot;creating hyperty descriptor based on: &quot;, result);

        // create the descriptor
        let hyperty = _this._factory.createHypertyDescriptorObject(
          result.cguid,
          result.objectName,
          result.description,
          result.language,
          result.sourcePackageURL,
          result.type,
          result.dataObjects
        );

        // console.log(&quot;created hyperty descriptor object:&quot;, hyperty);

        // parse and attach sourcePackage
        let sourcePackage = result.sourcePackage;
        let sourceCode = atob(sourcePackage.sourceCode);
        sourcePackage.sourceCode = sourceCode;
        if (sourcePackage) {
          // console.log(&quot;hyperty has sourcePackage:&quot;, sourcePackage);
          hyperty.sourcePackage = _this._createSourcePackage(_this._factory, sourcePackage);
        }

        console.log(&apos;hyperty has sourcePackage:&apos;, hyperty);

        resolve(hyperty);
      }
    });
  }

  /**
  * Get source Package from a URL
  * @param sourcePackageURL - e.g. mydomain.com/.well-known/hyperty/MyHyperty/sourcePackage
  * @returns {Promise}
  */
  getSourcePackageFromURL(sourcePackageURL) {
    let _this = this;

    // console.log(&quot;getting sourcePackage from:&quot;, sourcePackageURL);

    return new Promise(function(resolve, reject) {

      if (sourcePackageURL === &apos;/sourcePackage&apos;) {
        reject(&apos;sourcePackage is already contained in descriptor, please use it directly&apos;);
      }

      _this._makeExternalRequest(sourcePackageURL).then(function(result) {
        // console.log(&quot;got raw sourcePackage:&quot;, result);
        if (result.error) {
          // TODO handle error properly
          reject(result);
        } else {
          result = JSON.parse(result);

          let sourcePackage = result.sourcePackage;
          if (sourcePackage) {
            sourcePackage = _this._createSourcePackage(_this._factory, sourcePackage);
            resolve(sourcePackage);
          } else {
            reject(&apos;no source package&apos;);
          }
        }
      }).catch(function(reason) {
        reject(reason);
      });

    });

  }

  /**
  * Get StubDescriptor
  * @param stubURL - e.g. mydomain.com/.well-known/protostub/MyProtostub
  * @returns {Promise}
  */
  getStubDescriptor(stubURL) {
    let _this = this;

    // console.log(&quot;getting stub descriptor from: &quot; + stubURL);
    return new Promise(function(resolve, reject) {

      let dividedURL = divideURL(stubURL);
      let domain = dividedURL.domain;
      let protoStub = dividedURL.identity;

      if (!domain) {
        domain = stubURL;
      }

      if (!protoStub) {
        protoStub = &apos;default&apos;;
      } else {
        protoStub = protoStub.substring(protoStub.lastIndexOf(&apos;/&apos;) + 1);
      }

      let result = _this.ProtoStubs[protoStub];

      if (result.error) {
        // TODO handle error properly
        reject(result);
      } else {
        console.log(&apos;creating stub descriptor based on: &apos;, result);

        // create the descriptor
        let stub = _this._factory.createProtoStubDescriptorObject(
          result.cguid,
          result.objectName,
          result.description,
          result.language,
          result.sourcePackageURL,
          result.messageSchemas,
          JSON.stringify(result.configuration),
          result.constraints
        );

        // parse and attach sourcePackage
        let sourcePackage = result.sourcePackage;
        let sourceCode = atob(sourcePackage.sourceCode);
        sourcePackage.sourceCode = sourceCode;

        if (sourcePackage) {
          sourcePackage = _this._createSourcePackage(_this._factory, sourcePackage);
          stub.sourcePackage = sourcePackage;
        }
        resolve(stub);
      }
    });

  }

  /**
  * Get DataSchemaDescriptor
  * @param dataSchemaURL - e.g. mydomain.com/.well-known/dataschema/MyDataSchema
  * @returns {Promise}
  */
  getDataSchemaDescriptor(dataSchemaURL) {
    let _this = this;

    return new Promise(function(resolve, reject) {

      // request the json
      if (dataSchemaURL) {
        dataSchemaURL = dataSchemaURL.substring(dataSchemaURL.lastIndexOf(&apos;/&apos;) + 1);
      }

      let result = _this.DataSchemas[dataSchemaURL];

      if (result.ERROR) {
        // TODO handle error properly
        reject(result);
      } else {
        console.log(&apos;creating dataSchema based on: &apos;, result);

        // FIXME: accessControlPolicy field not needed?
        // create the descriptor
        let dataSchema = _this._factory.createDataObjectSchema(
          result.cguid,
          result.objectName,
          result.description,
          result.language,
          result.sourcePackageURL
        );

        console.log(&apos;created dataSchema descriptor object:&apos;, dataSchema);

        // parse and attach sourcePackage
        let sourcePackage = result.sourcePackage;
        if (sourcePackage) {
          // console.log(&apos;dataSchema has sourcePackage:&apos;, sourcePackage);
          dataSchema.sourcePackage = _this._createSourcePackage(_this._factory, sourcePackage);
          if (typeof dataSchema.sourcePackage.sourceCode === &apos;string&apos;) {
            dataSchema.sourcePackage.sourceCode = JSON.parse(dataSchema.sourcePackage.sourceCode);
          }
        }

        resolve(dataSchema);
      }
    });
  }

  _createSourcePackage(factory, sp) {
    // console.log(&quot;creating sourcePackage. factory:&quot;, factory, &quot;, raw package:&quot;, sp);
    try {
      sp = JSON.parse(sp);
    } catch (e) {
      console.log(&apos;parsing sourcePackage failed. already parsed? -&gt; &apos;, sp);
    }

    // check encoding
    if (sp.encoding === &apos;base64&apos;) {
      sp.sourceCode = atob(sp.sourceCode);
      sp.encoding = &apos;UTF-8&apos;;
    }

    let sourcePackage = factory.createSourcePackage(sp.sourceCodeClassname, sp.sourceCode);

    if (sp.hasOwnProperty(&apos;encoding&apos;))
    sourcePackage.encoding = sp.encoding;

    if (sp.hasOwnProperty(&apos;signature&apos;))
    sourcePackage.signature = sp.signature;

    return sourcePackage;
  }

}

export default RuntimeCatalogue;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.4)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
