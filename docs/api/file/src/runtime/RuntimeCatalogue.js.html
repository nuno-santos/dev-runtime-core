<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/runtime/RuntimeCatalogue.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="git+ssh://git@github.com:reTHINK-project/dev-runtime-core.git">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">bus</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/MessageBus.js~MessageBus.html">MessageBus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/MiniBus.js~MiniBus.html">MiniBus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/Pipeline.js~Pipeline.html">Pipeline</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">graphconnector</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/BloomFilter.js~BloomFilter.html">BloomFilter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/GlobalRegistryRecord.js~GlobalRegistryRecord.html">GlobalRegistryRecord</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/GraphConnector.js~GraphConnector.html">GraphConnector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/GraphConnectorContactData.js~GraphConnectorContactData.html">GraphConnectorContactData</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">identity</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/identity/IdentityModule.js~IdentityModule.html">IdentityModule</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">persistence</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-persistenceManager">persistenceManager</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">policy</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/PolicyEngine.js~PolicyEngine.html">PolicyEngine</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">protostub</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-activate">activate</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">registry</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/AddressAllocation.js~AddressAllocation.html">AddressAllocation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/HypertyDiscovery.js~HypertyDiscovery.html">HypertyDiscovery</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/HypertyInstance.js~HypertyInstance.html">HypertyInstance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/Registry.js~Registry.html">Registry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/RegistryDataModel.js~RegistryDataModel.html">RegistryDataModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">runtime</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/runtime/RuntimeCatalogue-Local.js~RuntimeCatalogue.html">RuntimeCatalogue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/runtime/RuntimeCatalogue.js~RuntimeCatalogue.html">RuntimeCatalogue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/runtime/RuntimeUA.js~RuntimeUA.html">RuntimeUA</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">sandbox</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/sandbox/Sandbox.js~Sandbox.html">Sandbox</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/sandbox/SandboxRegistry.js~SandboxRegistry.html">SandboxRegistry</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">syncher</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/syncher/ObjectAllocation.js~ObjectAllocation.html">ObjectAllocation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/syncher/SyncherManager.js~SyncherManager.html">SyncherManager</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/EventEmitter.js~EventEmitter.html">EventEmitter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-deepClone">deepClone</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-divideURL">divideURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-emptyObject">emptyObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-divideURL">divideURL</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/runtime/RuntimeCatalogue.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import {divideURL} from &apos;../utils/utils&apos;;
import {CatalogueFactory} from &apos;service-framework&apos;;
import {HypertyDescriptor, ProtocolStubDescriptor, SourcePackage} from &apos;service-framework&apos;;

class RuntimeCatalogue {

    constructor(nodeHttp, nodeHttps) {
        // console.log(&apos;runtime catalogue&apos;);
        let _this = this;
        _this._nodeHttp = nodeHttp;
        _this._nodeHttps = nodeHttps;
        _this._factory = new CatalogueFactory(false, undefined);
    }

    set runtimeURL(runtimeURL) {
        let _this = this;
        _this._runtimeURL = runtimeURL;
    }

    get runtimeURL() {
        let _this = this;
        return _this._runtimeURL;
    }

    /**
     * Get hypertyRuntimeURL
     */
    getHypertyRuntimeURL() {
        // TODO: check if this is real needed;
        return _hypertyRuntimeURL;
    }

    /**
     * make a http request to a given URL.
     * @param url
     * @returns {Promise}
     * @private
     */
    _makeExternalRequest(url, nodeHttp, nodeHttps) {
        // console.log(&quot;_makeExternalRequest&quot;, url);

        // TODO: make this request compatible with nodejs
        // at this moment, XMLHttpRequest only is compatible with browser implementation
        // nodejs doesn&apos;t support;
        return new Promise(function (resolve, reject) {
            let protocolmap = {
                &quot;hyperty-catalogue://&quot;: &quot;https://&quot;,
                &quot;https://&quot;: &quot;https://&quot;,
                &quot;http://&quot;: &quot;http://&quot;
            };

            let usedProtocol;

            let foundProtocol = false;
            for (var protocol in protocolmap) {
                if (url.slice(0, protocol.length) == protocol) {
                    // console.log(&quot;exchanging &quot; + protocol + &quot; with &quot; + protocolmap[protocol]);
                    url = protocolmap[protocol] + url.slice(protocol.length, url.length);
                    usedProtocol = protocolmap[protocol];
                    foundProtocol = true;
                    break;
                }
            }

            if (!foundProtocol) {
                reject(&quot;Invalid protocol of url: &quot; + url);
                return;
            }

            // nodejs specific http implementations for http &amp; https
            let nodeRequest;
            if (nodeHttp &amp;&amp; usedProtocol === &quot;http://&quot;) {
                nodeRequest = nodeHttp;
            } else if (nodeHttps &amp;&amp; usedProtocol === &quot;https://&quot;) {
                nodeRequest = nodeHttps;
            }

            if (nodeRequest) {
                // request should be the same for http &amp; https

                // get url without protocol
                let hostAndPath = url.slice(usedProtocol.length, url.length);

                // get host (+ port)
                let host = hostAndPath.slice(0, hostAndPath.indexOf(&quot;/&quot;));

                // get path
                let path = hostAndPath.slice(host.length, hostAndPath.length);

                // if host has port, extract port and remove it from host
                let port;
                if (host.indexOf(&quot;:&quot;) !== -1) {
                    port = host.slice(host.indexOf(&quot;:&quot;) + 1, host.length);
                    host = host.slice(0, host.indexOf(&quot;:&quot;));
                }

                // FIXME: remove rejectUnauthorized when catalogue is using valid certificates
                // FIXME: add error handling
                nodeRequest.get({
                    host: host,
                    port: port,
                    path: path,
                    rejectUnauthorized: false
                }, function (response) {
                    var body = &quot;&quot;;
                    response.on(&quot;data&quot;, function(d) {
                        body += d;
                    });
                    response.on(&quot;end&quot;, function() {
                        resolve(body);
                    });
                });
            } else if (typeof XMLHttpRequest !== &apos;undefined&apos;) {
                // generic request
                let xhr = new XMLHttpRequest();
                // console.log(url);
                xhr.open(&apos;GET&apos;, url, true);
                xhr.onreadystatechange = function (event) {
                    let xhr = event.currentTarget;
                    if (xhr.readyState === 4) {
                        // console.log(&quot;got response:&quot;, xhr);
                        if (xhr.status === 200) {
                            resolve(xhr.responseText);
                        } else {
                            // console.log(&quot;rejecting promise because of response code: 200 != &quot;, xhr.status);
                            reject(xhr.responseText);
                        }
                    }
                };


                xhr.send();
            } else {
                reject(&quot;no suitable implementation to send request for protocol &apos;&quot; + usedProtocol + &quot;&apos;.&quot;);
            }
        });

    }

    /**
     * Get HypertyDescriptor
     * @param hypertyURL - e.g. mydomain.com/.well-known/hyperty/MyHyperty
     * @returns {Promise}
     */
    getHypertyDescriptor(hypertyURL) {
        let _this = this;
        // console.log(&quot;getHypertyDescriptor&quot;, hypertyURL);

        return new Promise(function (resolve, reject) {

            // request the json
            _this._makeExternalRequest(hypertyURL, _this._nodeHttp, _this._nodeHttps).then(function (result) {
                result = JSON.parse(result);


                if (result[&quot;ERROR&quot;]) {
                    // TODO handle error properly
                    reject(result);
                } else {
                    // console.log(&quot;creating hyperty descriptor based on: &quot;, result);

                    // create the descriptor
                    let hyperty = _this._factory.createHypertyDescriptorObject(
                        result[&quot;cguid&quot;],
                        result[&quot;objectName&quot;],
                        result[&quot;description&quot;],
                        result[&quot;language&quot;],
                        result[&quot;sourcePackageURL&quot;],
                        result[&quot;type&quot;] || result[&quot;hypertyType&quot;],
                        result[&quot;dataObjects&quot;]
                    );

                    // console.log(&quot;created hyperty descriptor object:&quot;, hyperty);

                    // parse and attach sourcePackage
                    let sourcePackage = result[&quot;sourcePackage&quot;];
                    if (sourcePackage) {
                        // console.log(&quot;hyperty has sourcePackage:&quot;, sourcePackage);
                        hyperty.sourcePackage = _this._createSourcePackage(_this._factory, sourcePackage);
                    }

                    resolve(hyperty);
                }
            });
        });
    }

    /**
     * Get RuntimeDescriptor
     * @param runtimeURL - e.g. mydomain.com/.well-known/runtime/MyRuntime
     * @returns {Promise}
     */
    getRuntimeDescriptor(runtimeURL) {
        let _this = this;
        // console.log(&quot;getRuntimeDescriptor&quot;, runtimeURL);

        return new Promise(function (resolve, reject) {

            // request the json
            _this._makeExternalRequest(runtimeURL, _this._nodeHttp, _this._nodeHttps).then(function (result) {
                result = JSON.parse(result);


                if (result[&quot;ERROR&quot;]) {
                    // TODO handle error properly
                    reject(result);
                } else {

                    // parse capabilities first
                    try {
                        result[&quot;hypertyCapabilities&quot;] = JSON.parse(result[&quot;hypertyCapabilities&quot;]);
                        result[&quot;protocolCapabilities&quot;] = JSON.parse(result[&quot;protocolCapabilities&quot;]);
                    } catch (e) {
                        // already json object
                    }
                    console.log(&quot;creating runtime descriptor based on: &quot;, result);


                    // create the descriptor
                    let runtime = _this._factory.createHypertyRuntimeDescriptorObject(
                        result[&quot;cguid&quot;],
                        result[&quot;objectName&quot;],
                        result[&quot;description&quot;],
                        result[&quot;language&quot;],
                        result[&quot;sourcePackageURL&quot;],
                        result[&quot;type&quot;] || result[&quot;runtimeType&quot;],
                        result[&quot;hypertyCapabilities&quot;],
                        result[&quot;protocolCapabilities&quot;]
                    );

                    console.log(&quot;created runtime descriptor object:&quot;, runtime);

                    // parse and attach sourcePackage
                    let sourcePackage = result[&quot;sourcePackage&quot;];
                    if (sourcePackage) {
                        // console.log(&quot;runtime has sourcePackage:&quot;, sourcePackage);
                        runtime.sourcePackage = _this._createSourcePackage(_this._factory, sourcePackage);
                    }

                    resolve(runtime);
                }
            });
        });
    }

    /**
     * Get DataSchemaDescriptor
     * @param dataSchemaURL - e.g. mydomain.com/.well-known/dataschema/MyDataSchema
     * @returns {Promise}
     */
    getDataSchemaDescriptor(dataSchemaURL) {
        let _this = this;
        // console.log(&quot;getDataSchemaDescriptor&quot;, dataSchemaURL);

        return new Promise(function (resolve, reject) {

            // request the json
            _this._makeExternalRequest(dataSchemaURL, _this._nodeHttp, _this._nodeHttps).then(function (result) {
                result = JSON.parse(result);


                if (result[&quot;ERROR&quot;]) {
                    // TODO handle error properly
                    reject(result);
                } else {
                    console.log(&quot;creating dataSchema based on: &quot;, result);

                    // FIXME: accessControlPolicy field not needed?
                    // create the descriptor
                    let dataSchema = _this._factory.createDataObjectSchema(
                        result[&quot;cguid&quot;],
                        result[&quot;objectName&quot;],
                        result[&quot;description&quot;],
                        result[&quot;language&quot;],
                        result[&quot;sourcePackageURL&quot;]
                    );

                    console.log(&quot;created dataSchema descriptor object:&quot;, dataSchema);

                    // parse and attach sourcePackage
                    let sourcePackage = result[&quot;sourcePackage&quot;];
                    if (sourcePackage) {
                        // console.log(&quot;dataSchema has sourcePackage:&quot;, sourcePackage);
                        dataSchema.sourcePackage = _this._createSourcePackage(_this._factory, sourcePackage);
                    }

                    resolve(dataSchema);
                }
            });
        });
    }

    /**
     * Get source Package from a URL
     * @param sourcePackageURL - e.g. mydomain.com/.well-known/hyperty/MyHyperty/sourcePackage
     * @returns {Promise}
     */
    getSourcePackageFromURL(sourcePackageURL) {
        let _this = this;

         //console.log(&quot;getting sourcePackage from:&quot;, sourcePackageURL);

        return new Promise(function (resolve, reject) {
            _this._makeExternalRequest(sourcePackageURL, _this._nodeHttp, _this._nodeHttps).then(function (result) {
                 //console.log(&quot;got raw sourcePackage:&quot;, result);
                if (result[&quot;ERROR&quot;]) {
                    // TODO handle error properly
                    reject(result);
                } else {
                    result = JSON.parse(result);
                    let sourcePackage = _this._createSourcePackage(_this._factory, result);
                    resolve(sourcePackage);
                }
            }).catch(function (reason) {
                reject(reason);
            });

        });

    }

    /**
     * Get StubDescriptor
     * @param stubURL - e.g. mydomain.com/.well-known/protostub/MyProtostub
     * @returns {Promise}
     */
    getStubDescriptor(stubURL) {
        let _this = this;

        // console.log(&quot;getting stub descriptor from: &quot; + stubURL);
        return new Promise(function (resolve, reject) {

          let dividedURL = divideURL(stubURL);
          let domain = dividedURL.domain;
          let protoStub = dividedURL.identity;

          if (!domain) {
            domain = stubURL;
          }

          if (!protoStub) {
            protoStub = &apos;default&apos;;
          } else {
            protoStub = protoStub.substring(protoStub.lastIndexOf(&apos;/&apos;) + 1);
          }

            let url = &apos;hyperty-catalogue://&apos; + domain + &apos;/.well-known/protocolstub/&apos; + protoStub;

            _this._makeExternalRequest(url, _this._nodeHttp, _this._nodeHttps).then(function (result) {
                // console.log(&quot;makeExternalRequest returned: &quot;, result);

                result = JSON.parse(result);
                // console.log(&quot;parsed result: &quot;, result);

                if (result[&quot;ERROR&quot;]) {
                    // TODO handle error properly
                    reject(result);
                } else {
                    // console.log(&quot;creating stub descriptor based on: &quot;, result);

                    // create the descriptor
                    let stub = _this._factory.createProtoStubDescriptorObject(
                        result[&quot;cguid&quot;],
                        result[&quot;objectName&quot;],
                        result[&quot;description&quot;],
                        result[&quot;language&quot;],
                        result[&quot;sourcePackageURL&quot;],
                        result[&quot;messageSchemas&quot;],
                        result[&quot;configuration&quot;],
                        result[&quot;constraints&quot;]
                    );

                    // parse and attach the sourcePackage
                    let sourcePackage = result[&quot;sourcePackage&quot;];
                    if (sourcePackage) {
                        sourcePackage = _this._createSourcePackage(_this._factory, sourcePackage);
                        stub.sourcePackage = sourcePackage;
                    }
                    resolve(stub);
                }
            });
        });

    }

    /**
     * Returns the sourceCode of a given descriptor
     * @param descriptor - Catalogue Object that was retrieved using e.g. getHypertyDescriptor()
     * @returns {Promise}
     */
    getSourceCodeFromDescriptor(descriptor) {
        let _this = this;
        return new Promise(function (resolve, reject) {
            if (descriptor.sourcePackage) {
                //console.log(&quot;descriptor has sourcePackage&quot;);
                //console.log(&quot;returning sourceCode:&quot;, descriptor.sourcePackage.sourceCode);
                resolve(descriptor.sourcePackage.sourceCode);
            } else {
                //console.log(&quot;descriptor has no sourcePackage, getting it...&quot;);
                let sourcePackage = _this.getSourcePackageFromURL(descriptor.sourcePackageURL).then(function (sourcePackage) {
                    //console.log(&quot;got sourcePackage:&quot;, sourcePackage);
                    //console.log(&quot;returning sourceCode:&quot;, sourcePackage.sourceCode);
                    resolve(sourcePackage.sourceCode);
                });
            }
        });
    }

    _createSourcePackage(factory, sp) {
         //console.log(&quot;creating sourcePackage. factory:&quot;, factory, &quot;, raw package:&quot;, sp);
        try {
            sp = JSON.parse(sp);
        } catch (e) {
             console.log(&quot;parsing sourcePackage failed. already parsed? -&gt; &quot;, sp);
        }

        // check encoding
        if (sp[&quot;encoding&quot;] === &quot;base64&quot;) {
            sp[&quot;sourceCode&quot;] = atob(sp[&quot;sourceCode&quot;]);
        }

        let sourcePackage = factory.createSourcePackage(sp[&quot;sourceCodeClassname&quot;], sp[&quot;sourceCode&quot;]);
        if (sp[&quot;encoding&quot;])
            sourcePackage.encoding = sp[&quot;encoding&quot;];

        if (sp[&quot;signature&quot;])
            sourcePackage.signature = sp[&quot;signature&quot;];

        return sourcePackage;
    }

}

export default RuntimeCatalogue;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.4)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
