<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/syncher/SyncherManager.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="git+ssh://git@github.com:reTHINK-project/dev-runtime-core.git">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">bus</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/MessageBus.js~MessageBus.html">MessageBus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/MiniBus.js~MiniBus.html">MiniBus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/Pipeline.js~Pipeline.html">Pipeline</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">graphconnector</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/BloomFilter.js~BloomFilter.html">BloomFilter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/GlobalRegistryRecord.js~GlobalRegistryRecord.html">GlobalRegistryRecord</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/GraphConnector.js~GraphConnector.html">GraphConnector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/graphconnector/GraphConnectorContactData.js~GraphConnectorContactData.html">GraphConnectorContactData</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">identity</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/identity/IdentityModule.js~IdentityModule.html">IdentityModule</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">persistence</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-persistenceManager">persistenceManager</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">policy</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/policy/PolicyEngine.js~PolicyEngine.html">PolicyEngine</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">protostub</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-activate">activate</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">registry</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/AddressAllocation.js~AddressAllocation.html">AddressAllocation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/HypertyDiscovery.js~HypertyDiscovery.html">HypertyDiscovery</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/HypertyInstance.js~HypertyInstance.html">HypertyInstance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/Registry.js~Registry.html">Registry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/registry/RegistryDataModel.js~RegistryDataModel.html">RegistryDataModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">runtime</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/runtime/RuntimeCatalogue-Local.js~RuntimeCatalogue.html">RuntimeCatalogue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/runtime/RuntimeCatalogue.js~RuntimeCatalogue.html">RuntimeCatalogue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/runtime/RuntimeUA.js~RuntimeUA.html">RuntimeUA</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">sandbox</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/sandbox/Sandbox.js~Sandbox.html">Sandbox</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/sandbox/SandboxRegistry.js~SandboxRegistry.html">SandboxRegistry</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">syncher</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/syncher/ObjectAllocation.js~ObjectAllocation.html">ObjectAllocation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/syncher/SyncherManager.js~SyncherManager.html">SyncherManager</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/EventEmitter.js~EventEmitter.html">EventEmitter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-deepClone">deepClone</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-divideURL">divideURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-emptyObject">emptyObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-divideURL">divideURL</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/syncher/SyncherManager.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import { divideURL } from &apos;../utils/utils&apos;;
import ObjectAllocation from &apos;./ObjectAllocation&apos;;

/**
 * @author micaelpedrosa@gmail.com
 * Core Syncronization system.
 */
class SyncherManager {
  /* private
  _url: URL
  _bus: MiniBus
  _registry: Registry
  _allocator: ObjectAllocation

  _subscriptions: { ObjectURL: { owner: HypertyURL, schema: Schema, sl: MsgListener, cl: [MsgListener], subs: [HypertyURL] } }
  */

  constructor(runtimeURL, bus, registry, catalog, allocator) {
    let _this = this;

    _this._bus = bus;
    _this._registry = registry;
    _this._catalog = catalog;

    //TODO: these should be saved in persistence engine?
    _this._url = runtimeURL + &apos;/sm&apos;;
    _this._objectURL = runtimeURL + &apos;/object-allocation&apos;;
    _this._subscriptions = {};

    //TODO: this should not be hardcoded!
    _this._domain = divideURL(runtimeURL).domain;

    if (allocator) {
      _this._allocator = allocator;
    } else {
      _this._allocator = new ObjectAllocation(_this._objectURL, bus);
    }

    bus.addListener(_this._url, (msg) =&gt; {
      console.log(&apos;SyncherManager-RCV: &apos;, msg);
      switch (msg.type) {
        case &apos;create&apos;: _this._onCreate(msg); break;
        case &apos;delete&apos;: _this._onDelete(msg); break;
        case &apos;subscribe&apos;: _this._onLocalSubscribe(msg); break;
        case &apos;unsubscribe&apos;: _this._onLocalUnSubscribe(msg); break;
      }
    });
  }

  get url() { return this._url; }

  _onCreate(msg) {
    let _this = this;
    let owner = msg.from;
    let domain = divideURL(msg.from).domain;

    //TODO: 5-7 authorizeObjectCreation(owner, obj ???? )
    //TODO: other optional steps

    //get schema from catalogue and parse -&gt; (scheme, children)
    _this._catalog.getDataSchemaDescriptor(msg.body.schema).then((descriptor) =&gt; {
      let properties = descriptor.sourcePackage.sourceCode.properties;
      let scheme = properties.scheme ? properties.scheme.constant : &apos;resource&apos;;
      let children = properties.children ? properties.children.constant : [];

      _this._allocator.create(domain, scheme, children, 1).then((allocated) =&gt; {
        //TODO: get address from address allocator ?
        let objURL = allocated[0];
        let objSubscriptorURL = objURL + &apos;/subscription&apos;;

        //15. add subscription listener
        let subscriptorListener = _this._bus.addListener(objSubscriptorURL, (msg) =&gt; {
          console.log(objSubscriptorURL + &apos;-RCV: &apos;, msg);
          switch (msg.type) {
            case &apos;subscribe&apos;: _this._onRemoteSubscribe(objURL, msg); break;
            case &apos;unsubscribe&apos;: _this._onRemoteUnSubscribe(objURL, msg); break;
          }
        });

        let objSubscription = { owner: owner, children: children, sl: subscriptorListener, cl: [], subs: [] };
        _this._subscriptions[objURL] = objSubscription;

        //add children listeners...
        let childBaseURL = objURL + &apos;/children/&apos;;
        children.forEach((child) =&gt; {
          let childURL = childBaseURL + child;
          let childListener = _this._bus.addListener(childURL, (msg) =&gt; {

            //TODO: what todo here? Process child creations?
            console.log(&apos;SyncherManager-&apos; + childURL + &apos;-RCV: &apos;, msg);
          });

          objSubscription.cl.push(childListener);
        });

        //all ok, send response
        _this._bus.postMessage({
          id: msg.id, type: &apos;response&apos;, from: msg.to, to: owner,
          body: { code: 200, resource: objURL, children: children }
        });

        //19. send create to all observers, responses will be deliver to the Hyperty owner?
        setTimeout(() =&gt; {
          //schedule for next cycle needed, because the Reporter should be available.
          msg.body.authorise.forEach((hypertyURL) =&gt; {
            _this._bus.postMessage({
              type: &apos;create&apos;, from: owner, to: hypertyURL,
              body: { schema: msg.body.schema, resource: objURL, value: msg.body.value }
            });
          });
        });
      });
    }).catch((reason) =&gt; {
      _this._bus.postMessage({
        id: msg.id, type: &apos;response&apos;, from: msg.to, to: owner,
        body: { code: 500, desc: reason }
      });
    });
  }

  _onDelete(msg) {
    let _this = this;

    //TODO: where to get objectURL ?
    let objURL = &apos;&lt;objURL&gt;&apos;;

    //destroy all objURL listeners
    delete _this._subscriptions[objURL];
    _this._bus.removeAllListenersOf(objURL);
    _this._bus.removeAllListenersOf(objURL + &apos;/subscription&apos;);

    //TODO: destroy object in the registry?
  }

  _onRemoteSubscribe(objURL, msg) {
    let _this = this;
    let hypertyUrl = msg.body.subscriber;

    let subscription = _this._subscriptions[objURL];

    //27. validate if subscription already exists?
    if (subscription.subs.indexOf(hypertyUrl) !== -1) {
      let errorMsg = {
        id: msg.id, type: &apos;response&apos;, from: msg.to, to: hypertyUrl,
        body: {code: 500, desc: &apos;Subscription for (&apos; + objURL + &apos; : &apos; +  hypertyUrl + &apos;) already exists!&apos;}
      };

      _this._bus.postMessage(errorMsg);
      return;
    }

    //31. ask to subscribe to Syncher? (depends on the operation mode)
    //TODO: get mode from object!
    let mode = &apos;sub/pub&apos;;

    if (mode === &apos;sub/pub&apos;) {
      //forward to Hyperty owner
      let forwardMsg = {
        type: &apos;forward&apos;, from: _this._url, to: subscription.owner,
        body: { type: msg.type, from: hypertyUrl, to: objURL }
      };

      _this._bus.postMessage(forwardMsg, (reply) =&gt; {
        console.log(&apos;forward-reply: &apos;, reply);
        if (reply.body.code === 200) {
          //subscription accepted (add forward and subscription)
          _this._bus.addForward(objURL, hypertyUrl);
          subscription.subs.push(hypertyUrl);
        }

        //send subscribe-response
        _this._bus.postMessage({
          id: msg.id, type: &apos;response&apos;, from: msg.to, to: msg.from,
          body: reply.body
        });
      });
    }

  }

  _onRemoteUnSubscribe(objURL, msg) {
    let _this = this;
    let hypertyUrl = msg.from;

    let subs = _this._subscriptions[objURL].subs;
    let index = subs.indexOf(hypertyUrl);
    subs.splice(index, 1);

    //TODO: send un-subscribe message to Syncher? (depends on the operation mode)
  }

  _onLocalSubscribe(msg) {
    let _this = this;

    let domain = divideURL(msg.from).domain;
    let objURL = msg.body.resource;
    let objURLSubscription = objURL + &apos;/subscription&apos;;

    //get schema from catalogue and parse -&gt; (children)
    _this._catalog.getDataSchemaDescriptor(msg.body.schema).then((descriptor) =&gt; {
      let properties = descriptor.sourcePackage.sourceCode.properties;
      let children = properties.children ? properties.children.constant : [];
      let childBaseURL = objURL + &apos;/children/&apos;;

      //1. subscribe msg for the domain node
      let nodeSubscribeMsg = {
        type: &apos;subscribe&apos;, from: _this._url, to: &apos;domain://msg-node.&apos; + domain + &apos;/sm&apos;,
        body: { resource: msg.body.resource, children: children }
      };

      //2. subscribe in msg-node
      _this._bus.postMessage(nodeSubscribeMsg, (reply) =&gt; {
        console.log(&apos;node-subscribe-response: &apos;, reply);
        if (reply.body.code === 200) {
          //listener accepted (add forward and subscribe to reporter)
          _this._bus.addForward(objURL, msg.from);

          //add forward for children
          children.forEach((child) =&gt; {
            _this._bus.addForward(childBaseURL + child, msg.from);
          });

          //send provisional response
          this._bus.postMessage({
            id: msg.id, type: &apos;response&apos;, from: msg.to, to: msg.from,
            body: { code: 100, childrenResources: children }
          });

          let objSubscribeMsg = {
            id: msg.id, type: &apos;subscribe&apos;, from: _this._url, to: objURLSubscription,
            body: { subscriber: msg.from }
          };

          //subscribe to reporter SM
          _this._bus.postMessage(objSubscribeMsg, (reply) =&gt; {
            //forward to hyperty:
            reply.from = _this._url;
            reply.to = msg.from;
            this._bus.postMessage(reply);
          });
        } else {
          //listener rejected
          _this._bus.postMessage({
            id: msg.id, type: &apos;response&apos;, from: msg.to, to: msg.from,
            body: reply.body
          });
        }
      });
    });
  }

  _onLocalUnSubscribe(msg) {

  }

}

export default SyncherManager;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.4)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
