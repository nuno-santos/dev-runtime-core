<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: syncher/Syncher.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: syncher/Syncher.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import DataObjectReporter from './DataObjectReporter';
import DataObjectObserver from './DataObjectObserver';

/**
 * @author micaelpedrosa@gmail.com
 * Client API Syncronization system.
 */
class SyncherManager {
  /* private
  _owner: URL
  _bus: MiniBus

  _subURL: URL

  _reporters: &lt;url: DataObjectReporter>
  _observers: &lt;url: DataObjectObserver>

  ----event handlers----
  _onResponseHandlers: [(event) => void]
  */

 constructor(owner, bus, config) {
   let _this = this;

   _this._owner = owner;
   _this._bus = bus;

   _this._subURL = config.runtimeURL + '/sm';

   _this._reporters = {};
   _this._observers = {};

   _this._onResponseHandlers = [];

   bus.addListener(owner, (msg) => {
     console.log('Syncher-RCV: ', msg);
     switch (msg.type) {
       case 'response': _this._onResponse(msg); break;
       case 'forward': _this._onForward(msg); break;
       case 'create': _this._onCreate(msg); break;
       case 'update': _this._onChange(msg); break;
       case 'add': _this._onChange(msg); break;
       case 'remove': _this._onChange(msg); break;
     }
   });
 }

 get owner() { return this._owner; }

 get reporters() { return this._reporters; }

 get observers() { return this._observers; }

 /**
  * Request a DataObjectReporter creation. The URL will be be requested by the allocation mechanism.
  * @param  {Schema} schema Schema of the object
  * @param  {HypertyURL[]} List of hyperties to send the create
  * @param  {JSON} initialData Object initial data
  * @return {Promise&lt;DataObjectReporter>} Return Promise to a new Reporter. The reporter can be accepted or rejected by the PEP
  */
 create(schema, observers, initialData) {
   let _this = this;

   //TODO: what to do with schema?

   let requestMsg = {
     type: 'create', from: _this._owner, to: _this._subURL,
     body: {schema: schema, value: initialData, authorise: observers}
   };

   return new Promise((resolve, reject) => {
     //request create to the Allocation system? Can be rejected by the PolicyEngine.
     _this._bus.postMessage(requestMsg, (reply) => {
       console.log('create-response: ', reply);
       if (reply.body.code === 200) {
         let objUrl = reply.body.resource;

         //reporter creation accepted
         let newObj = new DataObjectReporter(objUrl, schema, _this._bus, 'on', initialData);
         _this._reporters[objUrl] = newObj;
         resolve(newObj);
       } else {
         //reporter creation rejected
         reject(reply.body.desc);
       }
     });
   });
 }

 /**
  * Request a subscription to an existent object.
  * @param  {ObjectURL} url Address of the existent object.
  * @return {Promise&lt;DataObjectObserver>} Return Promise to a new Observer.
  */
 subscribe(url) {
   let _this = this;
   let objSubscriptorURL = url + '/sm';

   //TODO: validate if subscription already exists ?
   let subscribeMsg = {
     type: 'subscribe', from: _this._owner, to: objSubscriptorURL
   };

   return new Promise((resolve, reject) => {
     //request subscription
     _this._bus.postMessage(subscribeMsg, (reply) => {
       console.log('subscribe-response: ', reply);
       if (reply.body.code === 200) {
         //subscription accepted
         let newObj = new DataObjectObserver(_this._owner, url, reply.body.schema, 'on', reply.body.value);
         _this._observers[url] = newObj;
         resolve(newObj);
       } else {
         //subscription rejected
         reject(reply.body.desc);
       }
     });
   });
 }

 onResponse(callback) {
   this._onResponseHandlers.push(callback);
 }

 _onResponse(msg) {
   let _this = this;

   //TODO: process create reponses!
 }

 _onForward(msg) {
   let _this = this;

   let reporter = _this._reporters[msg.body.to];
   reporter._onForward(msg);
 }

 _onCreate(msg) {
   let _this = this;

   let objURL = msg.body.resource;
   let newObj = new DataObjectObserver(_this._owner, objURL, msg.body.schema, 'on', msg.body.value);
   _this._observers[objURL] = newObj;
 }

 _onChange(msg) {
   let _this = this;

   let observer = _this._observers[msg.from];
   observer._changeObject(msg);
 }

}

export default SyncherManager;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-utils.html">utils</a></li></ul><h3>Classes</h3><ul><li><a href="AddressAllocation.html">AddressAllocation</a></li><li><a href="BloomFilter.html">BloomFilter</a></li><li><a href="EventEmitter.html">EventEmitter</a></li><li><a href="GraphConnector.html">GraphConnector</a></li><li><a href="GraphConnectorContactData.html">GraphConnectorContactData</a></li><li><a href="IdentityModule.html">IdentityModule</a></li><li><a href="MessageBus.html">MessageBus</a></li><li><a href="MiniBus.html">MiniBus</a></li><li><a href="Pipeline.html">Pipeline</a></li><li><a href="PolicyEngine.html">PolicyEngine</a></li><li><a href="ProtoStub.html">ProtoStub</a></li><li><a href="QoSUA.html">QoSUA</a></li><li><a href="Registry.html">Registry</a></li><li><a href="RuntimeUA.html">RuntimeUA</a></li><li><a href="Sandbox.html">Sandbox</a></li><li><a href="SandboxRegistry.html">SandboxRegistry</a></li><li><a href="SyncherManager.html">SyncherManager</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Wed Nov 25 2015 15:05:48 GMT+0100 (Mitteleurop√§ische Zeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
