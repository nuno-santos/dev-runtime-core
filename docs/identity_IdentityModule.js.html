<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: identity/IdentityModule.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: identity/IdentityModule.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
* IdentityModule
*
* Initial specification: D4.1
*
* The IdentityModule is a component managing user Identity. It downloads, instantiates
* and manage Identity Provider Proxy (IdP) for its own user identity or for external
* user identity verification.
*
*/
class IdentityModule {

  /**
  * USER'S OWN IDENTITY
  */
  constructor() {

  }

  /**
  * Register a new Identity with an Identity Provider
  */
  registerIdentity() {
    // Body...
  }

  /**
  * In relation with a classical Relying Party: Registration
  */
  registerWithRP() {
    // Body...
  }

  /**
  * In relation with a classical Relying Party: Login
  * @return {Promise}          Promise          IDToken
  */
  loginWithRP() {

    /*
      When calling this function, if everything is fine, a small pop-up will open requesting a login with a google account. After the login is made, the pop-up will close and the function will return the ID token.
      This function was tested with the URL: http://127.0.0.1:8080/ and with the same redirect URI

    	In case the redirect URI is not accepted or is required to add others redirect URIs, a little information is provided to fix the problem:

    	So that an application can use Google's OAuth 2.0 authentication system for user login,
    	first is required to set up a project in the Google Developers Console to obtain OAuth 2.0 credentials and set a redirect URI.
    	A test account was created to set the project in the Google Developers Console to obtain OAuth 2.0 credentials,	with the following credentials:
	        	username: openidtest10@gmail.com
	          password: testOpenID10

    	To add more URI's, follow the steps:
    	1º choose the project ( can be the My OpenID Project)	 from  https://console.developers.google.com/projectselector/apis/credentials using the credentials provided above.
    	2º Open The Client Web 1 listed in OAuth 2.0 Client ID's
    	3º Add the URI  in the authorized redirect URI section.
      4º change the REDIRECT parameter bellow with the pretended URI

    */
    let VALIDURL   =   'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=';
    let USERINFURL =   'https://www.googleapis.com/oauth2/v1/userinfo?access_token=';
    let OAUTHURL   =   'https://accounts.google.com/o/oauth2/auth?';
    let SCOPE      =   'https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email';
    let CLIENTID   =   '808329566012-tqr8qoh111942gd2kg007t0s8f277roi.apps.googleusercontent.com';
    let REDIRECT   =    'http://127.0.0.1:8080/';

    //let REDIRECT   =   document.URL.substring(0, document.URL.length - 1); //remove the '#' character
    let LOGOUT     =   'http://accounts.google.com/Logout';
    let TYPE       =   'token';
    let _url        =   OAUTHURL + 'scope=' + SCOPE + '&amp;client_id=' + CLIENTID + '&amp;redirect_uri=' + REDIRECT + '&amp;response_type=' + TYPE;
    let acToken;
    let tokenType;
    let expiresIn;
    let user;
    let tokenID;
    let loggedIn = false;

    //function to parse the query string in the given URL to obatin certain values
    function gup(url, name) {
      name = name.replace(/[\[]/, '\\\[').replace(/[\]]/, '\\\]');
      let regexS = '[\\#&amp;]' + name + '=([^&amp;#]*)';
      let regex = new RegExp(regexS);
      let results = regex.exec(url);
      if (results === null)
      return '';
      else
      return results[1];
    }

    return new Promise(function(resolve, reject) {

      //function to exchange the access token with an ID Token containing the information
      function getIDToken(token) {
        let req = new XMLHttpRequest();
        req.open('GET', USERINFURL + token, true);

        req.onreadystatechange = function(e) {
          if (req.readyState == 4) {
            if (req.status == 200) {
              //console.log('getUserInfo ', JSON.parse(req.responseText));
              tokenID = JSON.parse(req.responseText);
              resolve(tokenID);
            } else if (req.status == 400) {
              reject('There was an error processing the token');
            } else {
              reject('something else other than 200 was returned');
            }
          }
        };
        req.send();
      }

      // Body...
      //this will open a window with the URL which will open a page sent by google for the user to insert the credentials
      // when the google validates the credentials then send a access token
      let win = window.open(_url, 'openIDrequest', 'width=800, height=600');
      let pollTimer   =   window.setInterval(function() {
        try {
          //console.log(win.document.URL);
          if (win.document.URL.indexOf(REDIRECT) != -1) {
            window.clearInterval(pollTimer);
            let url =   win.document.URL;
            acToken =   gup(url, 'access_token');
            tokenType = gup(url, 'token_type');
            expiresIn = gup(url, 'expires_in');
            win.close();

            //after receiving the access token, and before exchange the access token for a ID token, google requires
            // to validate first the token.
            getIDToken(acToken);

          }
        } catch (e) {
          //console.log(e);
        }
      }, 500);
    });
  }

  /**
  * In relation with a Hyperty Instance: Associate identity
  */
  setHypertyIdentity() {
    // Body...
  }

  /**
  * Generates an Identity Assertion for a call session
  * @param  {DOMString} contents     contents
  * @param  {DOMString} origin       origin
  * @param  {DOMString} usernameHint usernameHint
  * @return {IdAssertion}              IdAssertion
  */
  generateAssertion(contents, origin, usernameHint) {
    // Body...
  }

  /**
  * OTHER USER'S IDENTITY
  */

  /**
  * Verification of a received IdAssertion validity
  * @param  {DOMString} assertion assertion
  */
  validateAssertion(assertion) {
    // Body...
  }

  /**
  * Trust level evaluation of a received IdAssertion
  * @param  {DOMString} assertion assertion
  */
  getAssertionTrustLevel(assertion) {
    // Body...
  }

}

export default IdentityModule;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-utils.html">utils</a></li></ul><h3>Classes</h3><ul><li><a href="AddressAllocation.html">AddressAllocation</a></li><li><a href="BloomFilter.html">BloomFilter</a></li><li><a href="EventEmitter.html">EventEmitter</a></li><li><a href="GraphConnector.html">GraphConnector</a></li><li><a href="GraphConnectorContactData.html">GraphConnectorContactData</a></li><li><a href="IdentityModule.html">IdentityModule</a></li><li><a href="MessageBus.html">MessageBus</a></li><li><a href="MiniBus.html">MiniBus</a></li><li><a href="Pipeline.html">Pipeline</a></li><li><a href="PolicyEngine.html">PolicyEngine</a></li><li><a href="ProtoStub.html">ProtoStub</a></li><li><a href="QoSUA.html">QoSUA</a></li><li><a href="Registry.html">Registry</a></li><li><a href="RuntimeUA.html">RuntimeUA</a></li><li><a href="Sandbox.html">Sandbox</a></li><li><a href="SandboxRegistry.html">SandboxRegistry</a></li><li><a href="SyncherManager.html">SyncherManager</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Wed Nov 25 2015 15:05:48 GMT+0100 (Mitteleuropäische Zeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
